# Redis-Service å’Œæ··åˆç¼“å­˜éƒ¨ç½²æŒ‡å—

## ğŸ“‹ é¡¹ç›®ç»“æ„è¯´æ˜

æœ¬é¡¹ç›®é‡‡ç”¨**æ··åˆç¼“å­˜æ¶æ„**ï¼Œç»“åˆäº†æœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜çš„ä¼˜åŠ¿ï¼š

```
æ¯ä¸ªå¾®æœåŠ¡                     ä¸­å¿ƒåŒ–æœåŠ¡
â”œâ”€ æœ¬åœ° Redis                 â”œâ”€ Redis-Service (API)
â”‚  - çƒ­ç‚¹æ•°æ®ç¼“å­˜             â”‚  â”œâ”€ å¹‚ç­‰æ€§æ£€æŸ¥
â”‚  - é›¶å»¶è¿Ÿè®¿é—®               â”‚  â”œâ”€ åˆ†å¸ƒå¼é”
â”‚  - æœåŠ¡éš”ç¦»                 â”‚  â””â”€ è·¨æœåŠ¡æ•°æ®å…±äº«
â”‚                              â”‚
â””â”€ HTTP è°ƒç”¨ redis-service   â””â”€ Shared Redis
   â”œâ”€ åˆ†å¸ƒå¼æ“ä½œ              â””â”€ ä¸­å¿ƒå­˜å‚¨åº“
   â””â”€ å¹‚ç­‰æ€§æ£€æŸ¥
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¼–è¯‘ Redis-Service

```bash
cd services/redis-service
mvn clean package -DskipTests
```

ç”Ÿæˆçš„ JAR æ–‡ä»¶ï¼š`target/redis-service-1.0.0.jar`

### 2. ä½¿ç”¨ Docker Compose éƒ¨ç½²ï¼ˆæ¨èï¼‰

#### åˆ›å»º docker-compose.yml

```yaml
version: '3.8'

services:
  # ==================== Redis å­˜å‚¨ ====================
  
  shared-redis:
    image: redis:7-alpine
    container_name: shared-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - live-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ==================== Redis æœåŠ¡ ====================
  
  redis-service:
    image: redis-service:latest
    container_name: redis-service
    build:
      context: ./services/redis-service
      dockerfile: Dockerfile
    ports:
      - "8085:8085"
    environment:
      - SPRING_APPLICATION_NAME=redis-service
      - SPRING_REDIS_HOST=shared-redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_DATABASE=10
      - SPRING_PROFILES_ACTIVE=docker
    depends_on:
      shared-redis:
        condition: service_healthy
    networks:
      - live-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/redis/api/v1/cache/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== å¾®æœåŠ¡ ====================
  
  anchor-service:
    image: anchor-service:latest
    build:
      context: ./services/anchor-service
      dockerfile: Dockerfile
    container_name: anchor-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/db1
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SPRING_REDIS_HOST=shared-redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_DATABASE=0
    depends_on:
      - mysql
      - shared-redis
      - redis-service
    networks:
      - live-network

  audience-service:
    image: audience-service:latest
    build:
      context: ./services/audience-service
      dockerfile: Dockerfile
    container_name: audience-service
    ports:
      - "8082:8082"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/db1
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SPRING_REDIS_HOST=shared-redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_DATABASE=1
    depends_on:
      - mysql
      - shared-redis
      - redis-service
    networks:
      - live-network

  # ==================== æ•°æ®åº“ ====================
  
  mysql:
    image: mysql:8.0
    container_name: mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - live-network

  # ==================== ç½‘å…³ ====================
  
  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./services/nginx/docker/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - redis-service
      - anchor-service
      - audience-service
    networks:
      - live-network

volumes:
  redis_data:
  mysql_data:

networks:
  live-network:
    driver: bridge
```

#### å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f redis-service
```

### 3. æ‰‹åŠ¨éƒ¨ç½²ï¼ˆLinuxï¼‰

#### å¯åŠ¨ Redis

```bash
redis-server --port 6379 --daemonize yes --appendonly yes
```

#### å¯åŠ¨ Redis-Service

```bash
cd services/redis-service
java -jar target/redis-service-1.0.0.jar \
  --server.port=8085 \
  --spring.redis.host=localhost \
  --spring.redis.port=6379 \
  --spring.redis.database=10 \
  --spring.profiles.active=production
```

#### å¯åŠ¨å…¶ä»–å¾®æœåŠ¡

```bash
cd services/anchor-service
java -jar target/anchor-service-1.0.0.jar \
  --server.port=8081 \
  --spring.redis.host=localhost \
  --spring.redis.port=6379 \
  --spring.redis.database=0
```

## ğŸ” éªŒè¯å®‰è£…

### 1. æ£€æŸ¥ Redis-Service æ˜¯å¦æ­£å¸¸è¿è¡Œ

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8085/redis/api/v1/cache/health

# å“åº”åº”è¯¥æ˜¯
{
  "success": true,
  "message": "Redis is healthy"
}
```

### 2. æµ‹è¯•å¹‚ç­‰æ€§æ£€æŸ¥

```bash
# é¦–æ¬¡è¯·æ±‚
curl -X POST "http://localhost:8085/redis/api/v1/lock/check-idempotency?idempotentKey=test-123&ttl=3600"

# å“åº”: success=true (é¦–æ¬¡è¯·æ±‚)
{
  "success": true,
  "message": "First request, proceed"
}

# ç«‹å³é‡å¤è¯·æ±‚
curl -X POST "http://localhost:8085/redis/api/v1/lock/check-idempotency?idempotentKey=test-123&ttl=3600"

# å“åº”: success=false (é‡å¤è¯·æ±‚)
{
  "success": false,
  "message": "Duplicate request, reject"
}
```

### 3. æµ‹è¯•åˆ†å¸ƒå¼é”

```bash
# è·å–é”
curl -X POST "http://localhost:8085/redis/api/v1/lock/try-lock?lockKey=task:demo&lockValue=node1&lockTimeout=30000"

# å“åº”
{
  "success": true,
  "message": "Lock acquired"
}

# é‡Šæ”¾é”
curl -X POST "http://localhost:8085/redis/api/v1/lock/release-lock?lockKey=task:demo&lockValue=node1"

# å“åº”
{
  "success": true,
  "message": "Lock released"
}
```

## ğŸ“Š æ¶æ„å·®å¼‚å¯¹æ¯”

### ä¹‹å‰ï¼ˆé›†ä¸­å¼ Redisï¼‰

```
æ‰€æœ‰æœåŠ¡ â†’ Nginx â†’ Redis-Service â†’ å•ä¸€ Redis
                    (ç“¶é¢ˆç‚¹)
```

**ç¼ºç‚¹**:
- âŒ Nginx å¢åŠ ç½‘ç»œå»¶è¿Ÿ
- âŒ Redis-Service æ˜¯ç“¶é¢ˆ
- âŒ æ‰€æœ‰ç¼“å­˜ç«äº‰èµ„æº

### ç°åœ¨ï¼ˆæ··åˆå¼ç¼“å­˜ï¼‰

```
æœ¬åœ°ç¼“å­˜: æœåŠ¡ â†’ æœ¬åœ° Redis (é›¶å»¶è¿Ÿ)
åˆ†å¸ƒå¼:   æœåŠ¡ â†’ redis-service â†’ Shared Redis
```

**ä¼˜ç‚¹**:
- âœ… æœ¬åœ°ç¼“å­˜: é›¶ç½‘ç»œå»¶è¿Ÿ
- âœ… åˆ†å¸ƒå¼æ“ä½œ: é€šè¿‡ API ç»Ÿä¸€ç®¡ç†
- âœ… Redis-Service: è½»é‡çº§ APIï¼Œä¸å¤„ç†å…·ä½“æ•°æ®
- âœ… æ›´é«˜çš„ååé‡å’Œæ›´ä½çš„å»¶è¿Ÿ

## ğŸ”§ é…ç½®æ–‡ä»¶

### Redis-Service application.yml

```yaml
server:
  port: 8085

spring:
  application:
    name: redis-service
  redis:
    host: localhost      # æ”¹ä¸ºä½ çš„ Redis åœ°å€
    port: 6379
    database: 10        # ä¸­å¿ƒåŒ– Redis æ•°æ®åº“ç¼–å·
    timeout: 2000
    password: ''        # å¦‚æœ Redis è®¾ç½®äº†å¯†ç 
    lettuce:
      pool:
        max-active: 32
        max-idle: 16
        min-idle: 8
```

### å„å¾®æœåŠ¡ application.yml

```yaml
spring:
  redis:
    host: localhost      # å„æœåŠ¡æœ¬åœ° Redis
    port: 6379
    database: 0          # ä¸åŒæœåŠ¡ä½¿ç”¨ä¸åŒçš„ DB (0/1/2/3...)
    timeout: 2000
    lettuce:
      pool:
        max-active: 16
        max-idle: 8
```

## ğŸ” ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. Redis é«˜å¯ç”¨éƒ¨ç½²

**ä½¿ç”¨ Redis Sentinelï¼ˆå“¨å…µï¼‰**:

```conf
# sentinel.conf
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 30000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000
```

å¯åŠ¨å“¨å…µ:
```bash
redis-sentinel sentinel.conf
```

### 2. Redis Clusterï¼ˆé›†ç¾¤ï¼‰

å¯¹äºè¶…å¤§è§„æ¨¡åº”ç”¨ï¼Œä½¿ç”¨ Redis Clusterï¼š

```bash
# åˆ›å»ºé›†ç¾¤
redis-cli --cluster create 127.0.0.1:7000 127.0.0.1:7001 ... --cluster-replicas 1
```

### 3. å®‰å…¨é…ç½®

```conf
# redis.conf
requirepass your_strong_password
bind 127.0.0.1           # åªå…è®¸æœ¬åœ°è¿æ¥
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300
daemonize yes
appendonly yes
```

### 4. ç›‘æ§å’Œå‘Šè­¦

ä½¿ç”¨ Redis Exporter + Prometheus + Grafanaï¼š

```yaml
redis-exporter:
  image: oliver006/redis_exporter:latest
  ports:
    - "9121:9121"
  environment:
    REDIS_ADDR: redis://shared-redis:6379
```

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¦åˆ†ç¦»æœ¬åœ° Redis å’Œä¸­å¿ƒ Redisï¼Ÿ

**A**: 
- æœ¬åœ° Redis: æä¾›é«˜æ€§èƒ½çš„çƒ­ç‚¹ç¼“å­˜ï¼ˆé›¶å»¶è¿Ÿï¼‰
- ä¸­å¿ƒ Redis: å¤„ç†åˆ†å¸ƒå¼æ“ä½œï¼ˆå¹‚ç­‰æ€§ã€åˆ†å¸ƒå¼é”ï¼‰
- è¿™ç§è®¾è®¡æé«˜äº†æ•´ä½“æ€§èƒ½ï¼ŒåŒæ—¶ä¿è¯äº†åˆ†å¸ƒå¼ä¸€è‡´æ€§

### Q2: Redis-Service ä¼šæˆä¸ºæ–°çš„ç“¶é¢ˆå—ï¼Ÿ

**A**: ä¸ä¼šï¼ŒåŸå› ï¼š
- Redis-Service ä¸å­˜å‚¨å¤§é‡æ•°æ®
- åªå¤„ç†è½»é‡çº§çš„å¹‚ç­‰æ€§æ£€æŸ¥å’Œé”æ“ä½œ
- å®é™…æ•°æ®ç¼“å­˜åœ¨å„æœåŠ¡çš„æœ¬åœ° Redis ä¸­
- å¯ä»¥æ°´å¹³æ‰©å±• Redis-Service å®ä¾‹

### Q3: æœ¬åœ° Redis å’Œä¸­å¿ƒ Redis æ•°æ®åŒæ­¥å—ï¼Ÿ

**A**: ä¸åŒæ­¥ï¼Œè®¾è®¡å¦‚ä¸‹ï¼š
- æœ¬åœ° Redis: çƒ­ç‚¹ç¼“å­˜ï¼ˆTTL æœ‰é™ï¼‰
- ä¸­å¿ƒ Redis: æŒä¹…åŒ–æ•°æ®ï¼ˆå¹‚ç­‰æ€§ã€åˆ†å¸ƒå¼é”ï¼‰
- ä¸éœ€è¦åŒæ­¥ï¼Œå„è‡ªèŒè´£æ¸…æ™°

### Q4: å¦‚æœä¸­å¿ƒ Redis å®•æœºæ€ä¹ˆåŠï¼Ÿ

**A**: æœ‰é™çº§æ–¹æ¡ˆï¼š
- IdempotentAspect æ•è·å¼‚å¸¸ï¼Œå…è®¸æ‰§è¡Œï¼ˆä¸æ¨èï¼‰
- ä½¿ç”¨ Redis Sentinel å®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»
- é…ç½®å¤šä¸ª Redis å‰¯æœ¬

## ğŸ“š å‚è€ƒèµ„æº

- [Redis å®˜æ–¹æ–‡æ¡£](https://redis.io)
- [Spring Data Redis](https://spring.io/projects/spring-data-redis)
- [Redis Cluster æ•™ç¨‹](https://redis.io/topics/cluster-tutorial)
- [Redis Sentinel æ•™ç¨‹](https://redis.io/topics/sentinel)

---

**ä½œè€…**: Live System Team  
**æœ€åæ›´æ–°**: 2026-01-02  
**ç‰ˆæœ¬**: 1.0.0
