# 直播打赏系统 - 数据库设计文档

## 目录

1. [数据库设计概述](#数据库设计概述)
2. [数据库分布](#数据库分布)
3. [核心表结构](#核心表结构)
4. [详细表设计](#详细表设计)
5. [索引策略](#索引策略)
6. [核心业务流程](#核心业务流程)

---

## 数据库设计概述

### 系统总体架构

- **DB1（观众服务数据库）**：用户注册、观众信息、打赏记录等
- **DB2（财务&分析数据库）**：分成结算、提现记录、分析统计数据等

### 设计原则

1. **高可用性**：支持分布式部署，避免单点故障
2. **高并发**：优化查询性能，合理使用索引
3. **数据一致性**：通过 traceId 保证幂等性，避免重复打赏
4. **可追溯性**：所有记录都包含链路追踪 ID 和时间戳

---

## 数据库分布

### DB1 - 观众服务数据库（audience-service）

**主要功能**：用户管理、观众管理、直播间管理、打赏明细记录

| 表名                  | 功能                | 归属服务 |
| --------------------- | ------------------- | -------- |
| user                  | 用户基础信息        | 观众服务 |
| anchor                | 主播信息(继承 user) | 观众服务 |
| audience              | 观众信息(继承 user) | 观众服务 |
| live_room             | 直播间基础信息      | 观众服务 |
| live_room_realtime    | 直播间实时数据      | 观众服务 |
| live_session_audience | 直播会话观众        | 观众服务 |
| message               | 弹幕消息            | 观众服务 |
| recharge              | 打赏明细记录        | 观众服务 |
| user_tag              | 用户标签关联        | 观众服务 |
| tag                   | 标签系统            | 观众服务 |

### DB2 - 财务&分析服务数据库（finance-service & analysis-service）

**主要功能**：财务结算、提现管理、数据分析

| 表名              | 功能               | 归属服务 |
| ----------------- | ------------------ | -------- |
| commission_rate   | 分成比例表(含历史) | 财务服务 |
| settlement        | 结算表             | 财务服务 |
| settlement_detail | 结算明细           | 财务服务 |
| withdrawal        | 提现记录           | 财务服务 |
| hourly_statistics | 小时统计表         | 分析服务 |
| audience_portrait | 观众画像表         | 分析服务 |
| sync_progress     | 数据同步进度表     | 分析服务 |

---

## 核心表结构

### 核心业务实体关系图

```
User (用户基类)
├─ Anchor (主播)
│  ├─ LiveRoom (直播间)
│  │  ├─ LiveRoomRealtime (直播间实时数据)
│  │  ├─ Message (弹幕)
│  │  ├─ LiveSessionAudience (会话观众)
│  │  └─ Recharge (打赏记录)
│  ├─ CommissionRate (分成比例)
│  └─ Settlement (结算)
│
└─ Audience (观众)
   ├─ Recharge (打赏记录)
   ├─ UserTag (用户标签)
   └─ AudiencePortrait (观众画像)
```

---

## 详细表设计

### DB1 - 观众服务数据库

#### 1. `user` - 用户基础表

**描述**：存储所有用户（观众、注册用户、游客）的基本信息

```sql
CREATE TABLE user (
    user_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    user_type INT NOT NULL DEFAULT 0 COMMENT '用户类型：0-游客、1-注册用户',
    gender INT NOT NULL DEFAULT 0 COMMENT '性别：0-未知、1-男、2-女',
    age INT COMMENT '年龄',
    username VARCHAR(64) UNIQUE COMMENT '用户名(注册用户)',
    nickname VARCHAR(128) NOT NULL COMMENT '昵称/姓名',
    password_hash VARCHAR(255) COMMENT '密码哈希值(注册用户)',
    email VARCHAR(128) UNIQUE COMMENT '邮箱',
    phone_number VARCHAR(20) UNIQUE COMMENT '电话号码',
    avatar_url VARCHAR(500) COMMENT '头像URL',
    bio VARCHAR(500) COMMENT '个人简介',
    ip_location VARCHAR(255) COMMENT 'IP地理位置',
    account_status INT NOT NULL DEFAULT 0 COMMENT '账户状态：0-正常、1-禁用、2-禁言、3-封禁',
    is_deleted INT NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除、1-已删除',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    INDEX idx_user_type (user_type),
    INDEX idx_username (username),
    INDEX idx_account_status (account_status),
    INDEX idx_create_time (create_time)
) COMMENT='用户基础表';
```

**字段说明**：

- `user_id`：全局唯一用户标识
- `user_type`：区分游客和注册用户，影响权限和功能可用性
- `ip_location`：用于分析用户地理分布和异常登录检测
- `account_status`：支持禁言、禁用等运营操作

---

#### 2. `anchor` - 主播信息表

**描述**：存储主播特有信息，继承 user 基本字段

```sql
CREATE TABLE anchor (
    user_id BIGINT PRIMARY KEY COMMENT '主播ID(外键引用user)',
    live_room_id BIGINT UNIQUE COMMENT '直播间ID(一一对应)',
    anchor_level INT NOT NULL DEFAULT 0 COMMENT '主播等级(影响分成)',
    like_count BIGINT NOT NULL DEFAULT 0 COMMENT '点赞数',
    fan_count BIGINT NOT NULL DEFAULT 0 COMMENT '粉丝数',
    available_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '可提取余额',
    total_earnings DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '累计收益',
    current_commission_rate DECIMAL(5,2) NOT NULL DEFAULT 50 COMMENT '当前分成比例(%)',
    banned_until DATETIME COMMENT '封禁截止时间(null表示未被封禁)',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (user_id) REFERENCES user(user_id),
    FOREIGN KEY (live_room_id) REFERENCES live_room(live_room_id),
    INDEX idx_live_room_id (live_room_id),
    INDEX idx_fan_count (fan_count),
    INDEX idx_total_earnings (total_earnings)
) COMMENT='主播信息表';
```

**字段说明**：

- `live_room_id`：与直播间一一对应，简化查询
- `current_commission_rate`：快速查询，避免多表关联
- `available_amount`：冗余字段，通过 settlement 计算得出，提升查询性能
- `banned_until`：支持临时封禁

---

#### 3. `audience` - 观众信息表

**描述**：存储观众特有信息，继承 user 基本字段

```sql
CREATE TABLE audience (
    user_id BIGINT PRIMARY KEY COMMENT '观众ID(外键引用user)',
    consumption_level INT NOT NULL DEFAULT 1 COMMENT '消费等级：0-低(后20%)、1-中(20%-80%)、2-高(前20%)',
    total_recharge_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '累计打赏金额',
    last_recharge_time DATETIME COMMENT '最后打赏时间',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (user_id) REFERENCES user(user_id),
    INDEX idx_consumption_level (consumption_level),
    INDEX idx_total_recharge_amount (total_recharge_amount),
    INDEX idx_last_recharge_time (last_recharge_time)
) COMMENT='观众信息表';
```

**字段说明**：

- `consumption_level`：根据打赏金额的分位数确定，支持观众人群分层
- `total_recharge_amount`：冗余字段，通过 recharge 表聚合计算，提升查询性能

---

#### 4. `live_room` - 直播间基础表

**描述**：存储直播间的基本信息和元数据

```sql
CREATE TABLE live_room (
    live_room_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '直播间ID',
    anchor_id BIGINT NOT NULL UNIQUE COMMENT '主播ID(唯一对应)',
    room_name VARCHAR(255) NOT NULL COMMENT '直播间名称',
    description VARCHAR(1000) COMMENT '直播间描述',
    room_status INT NOT NULL DEFAULT 0 COMMENT '状态：0-未开播、1-直播中、2-直播结束、3-被封禁',
    category VARCHAR(50) COMMENT '直播间分类：游戏、娱乐、户外等',
    cover_url VARCHAR(500) COMMENT '封面图URL',
    stream_url VARCHAR(500) COMMENT '直播流URL',
    max_viewers INT NOT NULL DEFAULT 10000 COMMENT '最大容纳观众数',
    start_time DATETIME COMMENT '上次开播时间',
    end_time DATETIME COMMENT '上次关播时间',
    total_earnings DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '累计收益',
    total_viewers BIGINT NOT NULL DEFAULT 0 COMMENT '累计观看人次',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (anchor_id) REFERENCES anchor(user_id),
    INDEX idx_anchor_id (anchor_id),
    INDEX idx_room_status (room_status),
    INDEX idx_category (category),
    INDEX idx_start_time (start_time)
) COMMENT='直播间基础表';
```

**字段说明**：

- `room_status`：支持运营管理（如直播间禁播）
- `category`：支持分类浏览和统计
- `total_earnings`、`total_viewers`：冗余字段，用于快速统计

---

#### 5. `live_room_realtime` - 直播间实时数据表

**描述**：存储直播间频繁更新的实时数据，与 live_room 一一对应

```sql
CREATE TABLE live_room_realtime (
    realtime_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '实时数据ID',
    live_room_id BIGINT NOT NULL UNIQUE COMMENT '直播间ID(一一对应)',
    current_viewer_count INT NOT NULL DEFAULT 0 COMMENT '当前观众数',
    current_revenue_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '当前场次收益',
    message_count BIGINT NOT NULL DEFAULT 0 COMMENT '弹幕数',
    recharge_count BIGINT NOT NULL DEFAULT 0 COMMENT '打赏数',
    online_duration BIGINT NOT NULL DEFAULT 0 COMMENT '在线时长(秒)',
    avg_latency INT NOT NULL DEFAULT 0 COMMENT '平均延迟(ms)',
    max_latency INT NOT NULL DEFAULT 0 COMMENT '最大延迟(ms)',
    version BIGINT NOT NULL DEFAULT 0 COMMENT '版本号(乐观锁)',
    last_update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',

    FOREIGN KEY (live_room_id) REFERENCES live_room(live_room_id),
    INDEX idx_live_room_id (live_room_id),
    INDEX idx_current_viewer_count (current_viewer_count)
) COMMENT='直播间实时数据表，频繁更新';
```

**字段说明**：

- `version`：乐观锁字段，支持并发更新
- `current_viewer_count`：实时观众数，需要高频更新，隔离在独立表中避免频繁锁定 live_room
- 设计为与 live_room 一一对应，便于关联查询

---

#### 6. `live_session_audience` - 直播会话观众表

**描述**：记录每个观众在某场直播中的信息，支持实时观众管理

```sql
CREATE TABLE live_session_audience (
    session_audience_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '会话观众ID',
    live_room_id BIGINT NOT NULL COMMENT '直播间ID',
    audience_id BIGINT NOT NULL COMMENT '观众ID',
    join_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '进入时间',
    leave_time DATETIME COMMENT '离开时间',
    watch_duration INT DEFAULT 0 COMMENT '观看时长(秒)',
    is_online INT NOT NULL DEFAULT 1 COMMENT '是否在线：0-离线、1-在线',

    FOREIGN KEY (live_room_id) REFERENCES live_room(live_room_id),
    FOREIGN KEY (audience_id) REFERENCES audience(user_id),
    UNIQUE KEY uk_session (live_room_id, audience_id, join_time),
    INDEX idx_live_room_id (live_room_id),
    INDEX idx_audience_id (audience_id),
    INDEX idx_is_online (is_online),
    INDEX idx_join_time (join_time)
) COMMENT='直播会话观众表，用于管理在线观众列表';
```

**字段说明**：

- `is_online`：快速查询在线观众，避免通过 leave_time 判断
- `uk_session`：同一观众在同一时间进入同一直播间只有一条记录
- 支持快速查询当前在线观众和计算观看时长

---

#### 7. `message` - 弹幕消息表

**描述**：存储直播间的弹幕消息

```sql
CREATE TABLE message (
    message_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '消息ID',
    live_room_id BIGINT NOT NULL COMMENT '直播间ID',
    sender_id BIGINT NOT NULL COMMENT '发送者ID',
    content VARCHAR(500) NOT NULL COMMENT '消息内容',
    message_type INT NOT NULL DEFAULT 0 COMMENT '消息类型：0-普通、1-系统、2-禁言',
    is_deleted INT NOT NULL DEFAULT 0 COMMENT '是否删除(软删除)：0-未删除、1-已删除',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

    FOREIGN KEY (live_room_id) REFERENCES live_room(live_room_id),
    FOREIGN KEY (sender_id) REFERENCES audience(user_id),
    INDEX idx_live_room_id (live_room_id),
    INDEX idx_sender_id (sender_id),
    INDEX idx_create_time (create_time)
) COMMENT='弹幕消息表';
```

**字段说明**：

- `is_deleted`：支持逻辑删除，保留审计信息
- 按直播间分区存储可提升大表性能（可选优化）

---

#### 8. `recharge` - 打赏明细记录表

**描述**：核心业务表，记录每一笔打赏，支持幂等性控制和多维度查询

```sql
CREATE TABLE recharge (
    recharge_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '打赏ID',
    live_room_id BIGINT NOT NULL COMMENT '直播间ID',
    anchor_id BIGINT NOT NULL COMMENT '主播ID',
    audience_id BIGINT NOT NULL COMMENT '观众ID',
    recharge_amount DECIMAL(15,2) NOT NULL COMMENT '打赏金额',
    recharge_type INT NOT NULL DEFAULT 0 COMMENT '打赏类型：0-普通、1-礼物、2-特殊',
    message VARCHAR(500) COMMENT '打赏消息',
    trace_id VARCHAR(64) NOT NULL UNIQUE COMMENT 'traceId(链路追踪&幂等控制)',
    status INT NOT NULL DEFAULT 0 COMMENT '状态：0-已入账、1-待结算、2-已结算、3-已退款',
    settlement_id BIGINT COMMENT '对应的结算ID',
    recharge_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '打赏时间',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (live_room_id) REFERENCES live_room(live_room_id),
    FOREIGN KEY (anchor_id) REFERENCES anchor(user_id),
    FOREIGN KEY (audience_id) REFERENCES audience(user_id),
    UNIQUE KEY uk_trace_id (trace_id),
    INDEX idx_live_room_id (live_room_id),
    INDEX idx_anchor_id (anchor_id),
    INDEX idx_audience_id (audience_id),
    INDEX idx_recharge_time (recharge_time),
    INDEX idx_status (status),
    INDEX idx_settlement_id (settlement_id)
) COMMENT='打赏明细记录表，核心业务表';
```

**字段说明**：

- `trace_id`：唯一约束，保证幂等性，防止重复打赏
- `status`：支持多个阶段的状态跟踪
- 多个索引支持不同维度查询：直播间、主播、观众、时间、结算
- **高并发优化**：
  - 可按 anchor_id 或 recharge_time 进行分区
  - traceId 索引保证快速去重检查
  - status 索引加速结算流程

---

#### 9. `tag` - 标签表

**描述**：系统标签，包括预设标签和自定义标签

```sql
CREATE TABLE tag (
    tag_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '标签ID',
    tag_name VARCHAR(100) NOT NULL UNIQUE COMMENT '标签名称',
    tag_type INT NOT NULL DEFAULT 0 COMMENT '标签类型：0-预设、1-自定义',
    category VARCHAR(50) COMMENT '标签分类：风格、兴趣、游戏、等等',
    description VARCHAR(500) COMMENT '标签描述',
    color VARCHAR(20) COMMENT '标签颜色(用于UI展示)',
    sort_order INT NOT NULL DEFAULT 0 COMMENT '排序顺序',
    is_deleted INT NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除、1-已删除',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    INDEX idx_tag_type (tag_type),
    INDEX idx_category (category),
    INDEX idx_sort_order (sort_order)
) COMMENT='标签表，支持预设和自定义标签';
```

**字段说明**：

- `tag_type`：区分系统预设标签和用户自定义标签
- `category`：标签分组，便于管理和查询

---

#### 10. `user_tag` - 用户标签关联表

**描述**：记录用户(主播/观众)与标签的关联关系及权重

```sql
CREATE TABLE user_tag (
    user_tag_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '关联ID',
    user_id BIGINT NOT NULL COMMENT '用户ID(主播或观众)',
    tag_id BIGINT NOT NULL COMMENT '标签ID',
    tag_type INT NOT NULL COMMENT '标签类型：0-用户标签(观众兴趣)、1-风格标签(主播风格)',
    weight DECIMAL(5,2) NOT NULL DEFAULT 1 COMMENT '权重(0-100)，用于推荐',
    score DECIMAL(5,2) NOT NULL DEFAULT 0 COMMENT '评分(0-5)，用于热度排序',
    is_manual INT NOT NULL DEFAULT 0 COMMENT '是否手动添加：0-自动、1-手动',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (user_id) REFERENCES user(user_id),
    FOREIGN KEY (tag_id) REFERENCES tag(tag_id),
    UNIQUE KEY uk_user_tag (user_id, tag_id),
    INDEX idx_user_id (user_id),
    INDEX idx_tag_id (tag_id),
    INDEX idx_weight (weight),
    INDEX idx_score (score)
) COMMENT='用户标签关联表';
```

**字段说明**：

- `weight`：用于标签推荐和关联推荐
- `score`：热度评分，用于排序
- `is_manual`：支持区分自动计算和手动设置的标签

---

#### 11. `tag_relation` - 标签关联度表

**描述**：记录标签之间的关联关系，支持推荐系统

```sql
CREATE TABLE tag_relation (
    relation_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '关联ID',
    tag_id1 BIGINT NOT NULL COMMENT '标签1 ID',
    tag_id2 BIGINT NOT NULL COMMENT '标签2 ID',
    relation_type INT NOT NULL DEFAULT 0 COMMENT '关联类型：0-推荐关联、1-互斥关联、2-强相关',
    relation_score DECIMAL(5,2) NOT NULL COMMENT '关联度分数(0-100)',
    cooccurrence_count BIGINT NOT NULL DEFAULT 0 COMMENT '共同出现次数',
    strength_level INT NOT NULL DEFAULT 1 COMMENT '关联强度等级：1-弱、2-中、3-强',
    last_calc_time DATETIME COMMENT '最后计算时间',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (tag_id1) REFERENCES tag(tag_id),
    FOREIGN KEY (tag_id2) REFERENCES tag(tag_id),
    UNIQUE KEY uk_tag_relation (tag_id1, tag_id2),
    INDEX idx_relation_score (relation_score),
    INDEX idx_relation_type (relation_type),
    INDEX idx_strength_level (strength_level)
) COMMENT='标签关联度表，用于推荐和分析';
```

**字段说明**：

- `relation_type`：支持不同类型的关联（推荐、冲突等）
- `cooccurrence_count`：统计共同出现的次数，用于计算关联度
- `strength_level`：快速查询强关联

---

### DB2 - 财务&分析服务数据库

#### 1. `commission_rate` - 分成比例表

**描述**：记录主播的分成比例及其变化历史，支持比例版本控制

```sql
CREATE TABLE commission_rate (
    commission_rate_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '分成比例ID',
    anchor_id BIGINT NOT NULL COMMENT '主播ID',
    anchor_name VARCHAR(128) NOT NULL COMMENT '主播名称(冗余，方便查询)',
    commission_rate DECIMAL(5,2) NOT NULL COMMENT '分成比例(%)',
    effective_time DATETIME NOT NULL COMMENT '生效时间',
    expire_time DATETIME COMMENT '过期时间(null表示未过期)',
    status INT NOT NULL DEFAULT 0 COMMENT '状态：0-未启用、1-启用、2-已过期',
    remark VARCHAR(500) COMMENT '操作备注(为什么调整)',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    INDEX idx_anchor_id (anchor_id),
    INDEX idx_effective_time (effective_time),
    INDEX idx_status (status)
) COMMENT='分成比例表，支持历史版本追踪';
```

**字段说明**：

- 记录所有历史版本，支持按时间查询主播的分成比例
- `status`：支持更灵活的状态管理
- 计算已结算应付金额时需要使用该表的历史版本

---

#### 2. `settlement` - 结算表

**描述**：记录主播的结算汇总信息

```sql
CREATE TABLE settlement (
    settlement_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '结算ID',
    anchor_id BIGINT NOT NULL UNIQUE COMMENT '主播ID(一一对应)',
    anchor_name VARCHAR(128) NOT NULL COMMENT '主播名称',
    settlement_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '结算金额(应付)',
    withdrawn_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '已提取金额',
    available_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '可提取金额(结算-已提取)',
    settlement_cycle INT NOT NULL DEFAULT 1 COMMENT '结算周期(天数)',
    last_settlement_time DATETIME COMMENT '上次结算时间',
    next_settlement_time DATETIME COMMENT '下次结算时间',
    status INT NOT NULL DEFAULT 0 COMMENT '状态：0-正常、1-冻结、2-禁提',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (anchor_id) REFERENCES anchor(user_id),
    INDEX idx_anchor_id (anchor_id),
    INDEX idx_status (status),
    INDEX idx_next_settlement_time (next_settlement_time)
) COMMENT='结算表，记录主播的可领取余额';
```

**字段说明**：

- `settlement_amount`：累计应付金额（通过分成比例计算）
- `withdrawn_amount`：已提取金额
- `available_amount`：可提取金额 = settlement_amount - withdrawn_amount
- 设计为一主播一条记录，便于查询和更新

---

#### 3. `settlement_detail` - 结算明细表

**描述**：记录每次结算的详细信息，支持账目审计

```sql
CREATE TABLE settlement_detail (
    detail_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '明细ID',
    settlement_id BIGINT NOT NULL COMMENT '结算ID',
    anchor_id BIGINT NOT NULL COMMENT '主播ID',
    total_recharge_amount DECIMAL(15,2) NOT NULL COMMENT '本期打赏总额',
    commission_rate DECIMAL(5,2) NOT NULL COMMENT '本期分成比例',
    settlement_amount DECIMAL(15,2) NOT NULL COMMENT '本期应付金额(总额 * 比例)',
    settlement_start_time DATETIME NOT NULL COMMENT '结算开始时间',
    settlement_end_time DATETIME NOT NULL COMMENT '结算结束时间',
    recharge_count INT NOT NULL DEFAULT 0 COMMENT '打赏笔数',
    status INT NOT NULL DEFAULT 0 COMMENT '状态：0-已结算、1-已对账、2-已审核',
    remark VARCHAR(500) COMMENT '备注',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

    FOREIGN KEY (settlement_id) REFERENCES settlement(settlement_id),
    INDEX idx_anchor_id (anchor_id),
    INDEX idx_settlement_start_time (settlement_start_time)
) COMMENT='结算明细表，支持按期查询结算情况';
```

**字段说明**：

- 记录每次结算周期的详细数据
- `commission_rate`：记录该期使用的比例（可能与当前比例不同）
- 支持账目审计和历史查询

---

#### 4. `withdrawal` - 提现记录表

**描述**：记录主播的提现请求和处理信息

```sql
CREATE TABLE withdrawal (
    withdrawal_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '提现ID',
    anchor_id BIGINT NOT NULL COMMENT '主播ID',
    anchor_name VARCHAR(128) NOT NULL COMMENT '主播名称',
    withdrawal_amount DECIMAL(15,2) NOT NULL COMMENT '提现金额',
    withdrawal_type INT NOT NULL DEFAULT 0 COMMENT '提现方式：0-银行卡、1-支付宝、2-微信',
    bank_name VARCHAR(100) COMMENT '开户行',
    bank_card_encrypted VARCHAR(255) COMMENT '银行卡号(加密存储)',
    account_holder VARCHAR(128) COMMENT '账户持有人名称',
    status INT NOT NULL DEFAULT 0 COMMENT '状态：0-申请中、1-处理中、2-已打款、3-失败、4-已拒绝',
    trace_id VARCHAR(64) NOT NULL UNIQUE COMMENT 'traceId(幂等性控制)',
    reject_reason VARCHAR(500) COMMENT '拒绝原因',
    transfer_serial_number VARCHAR(100) COMMENT '转账流水号',
    applied_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
    processed_time DATETIME COMMENT '处理时间',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (anchor_id) REFERENCES anchor(user_id),
    UNIQUE KEY uk_trace_id (trace_id),
    INDEX idx_anchor_id (anchor_id),
    INDEX idx_status (status),
    INDEX idx_applied_time (applied_time)
) COMMENT='提现记录表';
```

**字段说明**：

- `trace_id`：幂等性控制，防止重复提现
- `bank_card_encrypted`：加密存储敏感信息
- `status`：支持多个处理阶段

---

#### 5. `hourly_statistics` - 小时统计表

**描述**：按小时维度统计打赏数据，支持多维度分析查询

```sql
CREATE TABLE hourly_statistics (
    stat_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '统计ID',
    statistic_hour DATETIME NOT NULL COMMENT '统计小时(精确到小时)',
    anchor_id BIGINT COMMENT '主播ID',
    anchor_name VARCHAR(128) COMMENT '主播名称',
    anchor_gender INT COMMENT '主播性别',
    audience_gender INT COMMENT '打赏观众性别',
    total_recharge_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '打赏总金额',
    recharge_count INT NOT NULL DEFAULT 0 COMMENT '打赏笔数',
    unique_payer_count INT NOT NULL DEFAULT 0 COMMENT '付款人数',
    max_single_amount DECIMAL(15,2) COMMENT '单笔最大金额',
    avg_single_amount DECIMAL(15,2) COMMENT '单笔平均金额',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    INDEX idx_statistic_hour (statistic_hour),
    INDEX idx_anchor_id (anchor_id),
    INDEX idx_anchor_gender (anchor_gender),
    INDEX idx_audience_gender (audience_gender),
    INDEX idx_total_amount (total_recharge_amount),
    UNIQUE KEY uk_stat_dimension (statistic_hour, anchor_id, anchor_gender, audience_gender)
) COMMENT='小时统计表，支持多维度查询';
```

**字段说明**：

- 聚合 recharge 表数据，支持高效的多维度查询
- `uk_stat_dimension`：保证不重复统计
- 每 2 小时更新一次（可配置）
- 支持的查询维度：
  - 按小时
  - 按主播
  - 按主播性别
  - 按观众性别
  - 以上的任意组合

---

#### 6. `audience_portrait` - 观众画像表

**描述**：记录观众的消费等级和画像标签

```sql
CREATE TABLE audience_portrait (
    portrait_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '画像ID',
    audience_id BIGINT NOT NULL UNIQUE COMMENT '观众ID(一一对应)',
    audience_name VARCHAR(128) NOT NULL COMMENT '观众名称',
    total_recharge_amount DECIMAL(15,2) NOT NULL COMMENT '累计打赏金额',
    recharge_count INT NOT NULL DEFAULT 0 COMMENT '打赏笔数',
    consumption_percentile INT NOT NULL COMMENT '消费分位数(0-100)',
    consumption_level INT NOT NULL DEFAULT 1 COMMENT '消费等级：0-低(后20%)、1-中(20%-80%)、2-高(前20%)',
    portrait_description VARCHAR(500) COMMENT '画像描述(文字说明)',
    favorite_anchor_ids VARCHAR(1000) COMMENT '最喜欢的主播IDs(JSON)',
    favorite_categories VARCHAR(500) COMMENT '偏好的直播类别(JSON)',
    last_recharge_time DATETIME COMMENT '最后打赏时间',
    first_recharge_time DATETIME COMMENT '首次打赏时间',
    activity_level INT NOT NULL DEFAULT 0 COMMENT '活跃度等级：0-低、1-中、2-高',
    retention_days INT NOT NULL DEFAULT 0 COMMENT '留存天数',
    prediction_ltv DECIMAL(15,2) COMMENT '预测生命周期价值(LTV)',
    calc_time DATETIME NOT NULL COMMENT '计算时间',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (audience_id) REFERENCES audience(user_id),
    INDEX idx_audience_id (audience_id),
    INDEX idx_consumption_level (consumption_level),
    INDEX idx_consumption_percentile (consumption_percentile),
    INDEX idx_calc_time (calc_time)
) COMMENT='观众画像表，支持消费人群分层和标签化';
```

**字段说明**：

- `consumption_percentile`：消费分位数，0-20 为低，20-80 为中，80-100 为高
- `favorite_anchor_ids`、`favorite_categories`：JSON 格式存储，便于推荐
- `prediction_ltv`：预测客户生命周期价值，支持价值分析
- 每 2 小时更新一次

---

#### 7. `sync_progress` - 数据同步进度表

**描述**：记录观众服务与财务&分析服务的数据同步进度

```sql
CREATE TABLE sync_progress (
    progress_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '进度ID',
    sync_type INT NOT NULL COMMENT '同步类型：0-打赏数据同步、1-用户数据同步',
    source_service VARCHAR(50) NOT NULL COMMENT '数据源服务',
    target_service VARCHAR(50) NOT NULL COMMENT '目标服务',
    last_sync_recharge_id BIGINT NOT NULL DEFAULT 0 COMMENT '最后同步的打赏记录ID',
    total_synced_count BIGINT NOT NULL DEFAULT 0 COMMENT '累计同步笔数',
    total_synced_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '累计同步金额',
    last_sync_time DATETIME COMMENT '最后同步时间',
    next_sync_time DATETIME COMMENT '下次同步时间',
    sync_status INT NOT NULL DEFAULT 0 COMMENT '状态：0-待同步、1-同步中、2-已同步、3-失败',
    error_message VARCHAR(500) COMMENT '错误信息',
    sync_interval_seconds INT NOT NULL DEFAULT 300 COMMENT '同步间隔(秒)',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    INDEX idx_sync_type (sync_type),
    INDEX idx_last_sync_time (last_sync_time)
) COMMENT='数据同步进度表，记录观众服务和财务分析服务的同步状态';
```

**字段说明**：

- `last_sync_recharge_id`：记录上次同步到哪条打赏记录，支持断点续传
- `sync_status`：支持检测同步是否卡住
- 支持多种同步类型和服务间同步

---

## 索引策略

### 核心性能索引

#### 高并发索引

| 表名               | 索引字段                 | 优先级 | 说明                         |
| ------------------ | ------------------------ | ------ | ---------------------------- |
| recharge           | trace_id                 | **P0** | 去重检查，防止重复打赏       |
| recharge           | anchor_id, recharge_time | **P0** | 结算时快速查询主播的打赏数据 |
| recharge           | status                   | **P0** | 结算流程快速过滤             |
| live_room_realtime | live_room_id             | **P0** | 实时数据频繁更新             |
| anchor             | live_room_id             | **P0** | 快速查询主播对应的直播间     |

#### 功能性索引

| 表名              | 索引字段                                                    | 优先级 | 说明               |
| ----------------- | ----------------------------------------------------------- | ------ | ------------------ |
| hourly_statistics | (statistic_hour, anchor_id, anchor_gender, audience_gender) | **P1** | 多维度查询         |
| audience_portrait | consumption_level                                           | **P1** | 按消费等级快速查询 |
| recharge          | (anchor_id, recharge_time)                                  | **P1** | TOP10 查询         |
| message           | (live_room_id, create_time)                                 | **P1** | 弹幕历史查询       |

### 分区策略（可选优化）

```sql
-- recharge表按anchor_id或时间分区，支持大数据量
ALTER TABLE recharge PARTITION BY RANGE (YEAR(recharge_time)) (
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION pmax VALUES LESS THAN MAXVALUE
);

-- 或按主播分区
ALTER TABLE recharge PARTITION BY HASH(anchor_id) PARTITIONS 16;
```

---

## 核心业务流程

### 1. 打赏流程（高并发）

```
模拟服务
  ↓
观众服务.recharge表 (traceId去重)
  ↓
财务服务.settlement (定时结算)
  ↓
分析服务.hourly_statistics (定时统计)
```

**关键设计**：

- recharge 表的 traceId 唯一约束保证幂等性
- status 字段支持异步处理
- settlement 表冗余计算可提取余额，提升查询性能

---

### 2. 分成结算流程

```
获取主播的打赏数据 (recharge.status=0/1)
  ↓
查询该期的分成比例 (commission_rate按生效时间查询)
  ↓
计算应付金额 = 打赏总额 * 分成比例
  ↓
插入settlement_detail记录本期结算
  ↓
更新settlement表的余额
```

**关键设计**：

- commission_rate 表记录历史版本，支持比例变化计算
- 同一笔打赏可能使用不同时期的分成比例
- settlement 表一主播一条记录，便于快速查询

---

### 3. 提现流程

```
主播申请提现
  ↓
验证available_amount >= 提现金额
  ↓
插入withdrawal记录 (status=0)
  ↓
财务审核 (status->1)
  ↓
打款 (status->2)
  ↓
更新settlement.withdrawn_amount
```

**关键设计**：

- trace_id 幂等性控制
- status 字段记录处理阶段

---

### 4. 观众画像计算流程

```
定时任务(每2小时)
  ↓
查询sync_progress.last_sync_recharge_id之后的打赏数据
  ↓
按audience_id聚合，计算累计打赏金额
  ↓
计算消费分位数和等级 (后20%->0, 20%-80%->1, 前20%->2)
  ↓
更新audience_portrait表
  ↓
更新audience.consumption_level (冗余字段)
  ↓
更新sync_progress
```

**关键设计**：

- sync_progress 表记录同步进度，支持断点续传
- audience_portrait 和 hourly_statistics 定时更新，离线计算

---

### 5. 多维度查询流程

```
用户查询 "18-22点、男性观众、主播A的每小时打赏"
  ↓
查询hourly_statistics表
  WHERE statistic_hour BETWEEN '2025-01-02 18:00:00' AND '2025-01-02 22:59:59'
    AND anchor_id = A_ID
    AND audience_gender = 1
  ↓
返回结果用于仪表板展示
```

**关键设计**：

- hourly_statistics 预计算多维数据，避免实时聚合
- uk_stat_dimension 唯一约束保证数据不重复

---

## 数据一致性保证

### 1. 幂等性设计

- **打赏记录**：通过 recharge.trace_id 唯一约束，防止重复入账
- **提现记录**：通过 withdrawal.trace_id 唯一约束，防止重复打款
- **API 设计**：所有修改操作都应包含 trace_id 参数

### 2. 事务支持

- 打赏入账是单个 recharge INSERT，原子性强
- 结算流程需要事务：INSERT settlement_detail + UPDATE settlement
- 提现流程需要事务：UPDATE settlement + INSERT withdrawal

### 3. 最终一致性

- 分析数据(hourly_statistics, audience_portrait)通过定时任务更新
- 允许数据短期落后，每 2 小时同步一次
- sync_progress 表记录同步进度

---

## 性能优化建议

### 1. 缓存策略

- 主播分成比例：缓存当前有效的比例，避免频繁查询
- 观众画像：缓存消费等级和标签信息
- 直播间实时数据：缓存当前观众数等热数据

### 2. 查询优化

- 避免大表全表扫描，利用索引
- 使用 EXPLAIN 分析慢查询
- hourly_statistics 预计算多维数据，避免实时聚合

### 3. 写入优化

- 批量插入统计数据
- 使用 INSERT IGNORE 或 ON DUPLICATE KEY UPDATE 处理重复
- 定时删除软删除的历史数据

### 4. 分布式部署

- 考虑主从复制，读写分离
- 观众服务可使用单独的数据库实例
- 财务&分析数据库可使用单独的数据库实例

---

## 数据量估算

### 假设条件

- 100 个主播，300,000 个观众
- 平均每个打赏 2 秒（500/s \* 节点数）
- 运行周期：1 个月

### 数据规模

| 表名              | 预计行数            | 预计大小 |
| ----------------- | ------------------- | -------- |
| user              | 300,100             | ~100MB   |
| recharge          | ~172,800,000        | ~50GB    |
| message           | ~10,000,000         | ~5GB     |
| hourly_statistics | ~720                | ~1MB     |
| audience_portrait | 300,000             | ~500MB   |
| hourly_statistics | 720 \* 4 维 = 2,880 | ~50MB    |

**建议**：

- recharge 表超大，建议分区或分表
- 定期归档历史数据到 OLAP 系统
- 考虑使用列式存储(Elasticsearch)用于分析查询

---

## 数据库初始化脚本

完整的 SQL 脚本见附录或单独的 SQL 文件。

---

## 总结

该数据库设计充分考虑了：

1. **高并发**：合理的索引和分区策略
2. **幂等性**：通过 traceId 防止重复
3. **可追溯性**：记录详细的业务流程
4. **可扩展性**：支持主播、观众、标签等灵活管理
5. **数据分析**：预计算统计表支持多维查询

可根据实际业务量和性能测试结果进一步优化。
