# 主播服务 (Anchor Service) - 系统设计文档

## 📋 文档信息

| 项目 | 内容 |
|------|------|
| **服务名称** | anchor-service |
| **服务端口** | 8081 |
| **上下文路径** | /anchor |
| **职责** | 主播信息管理、直播间生命周期管理、分成比例配置、打赏TOP10统计 |
| **版本** | 2.0.0 |
| **最后更新** | 2026-01-06 |
| **重构状态** | ✅ 已完成 - 使用 Common 模块统一数据访问 |

---

## 🚀 重构说明 (v2.0.0)

### 架构变更
- **统一数据访问**：所有数据访问通过 `DataAccessFacade` 进行
- **移除重复缓存**：删除 Service 层的缓存注解，使用 Common 模块统一缓存策略
- **简化代码逻辑**：Service 层代码量减少约 30-40%
- **提高可维护性**：降低与 Repository 的耦合度

### 详细说明
请参考 [重构总结文档](../REFACTOR_SUMMARY.md)

---

## 🎯 核心功能

### 1. 主播管理 (Anchor Management)

#### 1.1 主播基础操作
- **注册/创建主播**: 基于User实体创建Anchor，初始化主播特有属性（等级、认证状态、粉丝数等）
- **查询主播信息**: 支持单个主播查询、主播列表查询、认证状态查询
- **修改主播信息**: 支持修改昵称、性别、年龄、IP地理位置等
- **搜索主播**: 按昵称、认证状态、等级、粉丝数等维度搜索
- **主播状态管理**: 启用/禁用主播账户

#### 1.2 主播数据统计
- **粉丝数统计**: 实时更新主播粉丝数
- **点赞数统计**: 统计主播获赞总数
- **认证管理**: 管理主播认证状态 (0-未认证、1-已认证、2-认证中)
- **直播总时长**: 记录主播历史直播时长


#### 1.3 提现管理
- **可提取余额管理**: 维护主播的可提取金额(availableAmount)
- **提现规则**: 根据打赏金额和分成比例计算可提取金额
- **提现申请**: 主播申请提现，记录申请信息
- **提现记录**: 记录提现申请、处理结果、处理时间
- **提现处理**: 提现成功后更新主播可提取金额、提现记录、提现申请
- **提现失败处理**: 提现失败后更新主播可提取金额、提现记录、提现申请
- **联动财务服务**: 通过Feign调用finance-service处理提现逻辑

### 2. 直播间管理 (Live Room Management)

#### 2.1 直播间生命周期
- **创建直播间**: 主播一一对应一个直播间，创建时关联anchorId
- **直播开启**: 设置roomStatus=1，记录startTime，初始化观众数=0
- **直播中**: 实时更新当前观众数、累计浏览量、总营收等数据
- **直播结束**: 设置roomStatus=2，保存最终数据
- **直播封禁**: 设置roomStatus=3，禁止进行直播活动

#### 2.2 直播间实时数据
- **在线观众数**: 实时统计当前在线观众数(currentViewerCount)
- **观众数据**: 实时收集观众数据，观众进入，离开，发送弹幕，打赏，整理为观众表，弹幕表，打赏表，使用redis缓存热点数据
- **累计浏览量**: 直播周期内的累计浏览量(totalViewCount)
- **本次营收**: 该场直播的总营收(totalEarnings)
- **直播流**: 存储直播流URL，支持与直播平台集成

#### 2.3 直播间分类和标签
- **分类管理**: 支持游戏、娱乐、户外、音乐等分类
- **标签关联**: 使用Tag和TagRelation表，支持多标签绑定
- **关联度计算**: 根据观众行为动态更新标签权重，

### 3. 分成比例管理 (Commission Rate Management)

#### 3.1 比例配置
- **动态配置**: 支持随时调整主播分成比例 (0-100%)
- **历史记录**: CommissionRate表记录每次配置变更
- **生效时间**: 支持即时生效或定时生效(effectiveTime)
- **过期管理**: 支持设置过期时间(expireTime)，过期后自动变更状态

#### 3.2 结算规则
- **新旧比例并行**: 变更前按原比例结算，变更后按新比例结算
- **时间点区分**: 根据打赏时间判断应用哪个分成比例
- **审计日志**: 所有比例变更都记录备注(remark)和操作时间

### 4. 打赏TOP10统计 (Top 10 Reward Ranking)

#### 4.1 统计逻辑
- **数据来源**: 从财务服务回调的Recharge消息和表获取打赏记录
- **统计维度**: 按打赏金额(rechargeAmount)降序排列，取TOP10
- **时间限制**: 可按不同时间维度统计（日、周、月、总）
- **定时任务**: 每小时自动执行一次统计任务

#### 4.2 缓存与性能
- **Redis缓存**: 使用key=`anchor:{anchorId}:top10_{period}`缓存结果
- **缓存TTL**: 
  - 日榜: 2小时
  - 周榜: 12小时
  - 月榜: 24小时
  - 总榜: 48小时
- **分布式锁**: 使用Redis分布式锁确保多节点部署时只有一个节点执行统计

#### 4.3 接口设计
```
GET /anchor/api/v1/anchors/{anchorId}/top10-audiences?period=day
参数:
  - period: day(日) | week(周) | month(月) | all(总) [默认: all]

响应示例:
{
  "code": 0,
  "message": "查询成功",
  "data": [
    {
      "rank": 1,
      "audienceId": 123,
      "audienceNickname": "粉丝1",
      "totalRecharge": 10000.00,
      "rechargeCount": 50
    },
    ...
  ]
}
```

---

## 📊 核心数据模型

### 1. Anchor (主播)
**继承自**: User  
**表名**: anchor  
**主要字段**:
| 字段名 | 类型 | 说明 |
|--------|------|------|
| user_id | BIGINT | 用户ID (主键，FK) |
| anchor_level | INT | 主播等级 (0-普通, 1-优质, 2-顶级) |
| ip_location | VARCHAR(256) | IP地理位置 |
| available_amount | DECIMAL(15,2) | 可提取余额 |
| live_room_id | BIGINT | 直播间ID (FK) |
| like_count | BIGINT | 点赞数 |
| fan_count | BIGINT | 粉丝数 |
| verification_status | INT | 认证状态 (0-未认证, 1-已认证, 2-认证中) |
| total_broadcast_minutes | BIGINT | 直播总时长(分钟) |
| first_broadcast_time | DATETIME | 首次直播时间 |

**关键索引**: 
- idx_user_id (user_id)
- idx_live_room_id (live_room_id)

### 2. LiveRoom (直播间)
**表名**: live_room  
**主要字段**:
| 字段名 | 类型 | 说明 |
|--------|------|------|
| live_room_id | BIGINT | 直播间ID (主键) |
| anchor_id | BIGINT | 主播ID (FK, UNIQUE) |
| anchor_name | VARCHAR(128) | 主播名称 |
| room_name | VARCHAR(256) | 直播间名称 |
| description | VARCHAR(1000) | 直播间描述 |
| room_status | INT | 状态 (0-未开播, 1-直播中, 2-直播结束, 3-被封禁) |
| category | VARCHAR(128) | 分类标签 |
| cover_url | VARCHAR(500) | 封面图URL |
| stream_url | VARCHAR(500) | 直播流URL |
| start_time | DATETIME | 开播时间 |
| expected_duration | INT | 预期直播时长(分钟) |
| current_viewer_count | BIGINT | 当前在线观众数 |
| total_view_count | BIGINT | 累计浏览量 |
| total_earnings | DECIMAL(15,2) | 总营收 |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

**关键索引**: 
- idx_anchor_id (anchor_id)
- idx_room_status (room_status)
- idx_start_time (start_time)

### 3. CommissionRate (分成比例)
**表名**: commission_rate  
**主要字段**:
| 字段名 | 类型 | 说明 |
|--------|------|------|
| commission_rate_id | BIGINT | 配置ID (主键) |
| anchor_id | BIGINT | 主播ID (FK) |
| anchor_name | VARCHAR(128) | 主播名称 |
| commission_rate | DOUBLE | 分成比例 (百分比) |
| effective_time | DATETIME | 生效时间 |
| expire_time | DATETIME | 过期时间 |
| status | INT | 状态 (0-未启用, 1-启用, 2-已过期) |
| remark | VARCHAR(500) | 操作备注 |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

**关键索引**: 
- idx_anchor_id (anchor_id)
- idx_effective_time (effective_time)
- idx_status (status)

### 4. Recharge (打赏记录) - 来自观众服务
**表名**: recharge  
**用途**: 存储所有打赏记录，anchor-service通过查询该表获取打赏数据  
**关键字段**:
| 字段名 | 类型 | 说明 |
|--------|------|------|
| recharge_id | BIGINT | 打赏ID |
| live_room_id | BIGINT | 直播间ID (FK) |
| anchor_id | BIGINT | 主播ID (FK) |
| anchor_name | VARCHAR(128) | 主播名称 |
| audience_id | BIGINT | 观众ID (FK) |
| audience_nickname | VARCHAR(128) | 观众昵称 |
| recharge_amount | DECIMAL(15,2) | 打赏金额 |
| recharge_time | DATETIME | 打赏时间 |
| trace_id | VARCHAR(64) | 链路追踪ID (UNIQUE) |
| recharge_type | INT | 打赏类型 |
| message | VARCHAR(500) | 打赏消息 |
| status | INT | 状态 (0-已入账, 1-待结算, 2-已结算, 3-已退款) |
| settlement_id | BIGINT | 对应的结算ID |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

**关键索引**: 
- idx_anchor_id (anchor_id)
- idx_live_room_id (live_room_id)
- idx_audience_id (audience_id)
- idx_trace_id (trace_id)

---

## 🏗️ 项目结构

```
anchor-service/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/liveroom/anchor/
│   │   │       ├── AnchorServiceApplication.java           # 启动类
│   │   │       ├── config/
│   │   │       │   ├── RedisConfig.java                   # Redis配置
│   │   │       │   ├── WebConfig.java                     # Web MVC配置
│   │   │       │   └── FeignConfig.java                   # Feign客户端配置
│   │   │       ├── controller/
│   │   │       │   ├── AnchorController.java              # 主播相关接口
│   │   │       │   ├── LiveRoomController.java            # 直播间相关接口
│   │   │       │   └── CommissionRateController.java      # 分成比例相关接口
│   │   │       ├── service/
│   │   │       │   ├── AnchorService.java                 # 主播业务逻辑
│   │   │       │   ├── LiveRoomService.java               # 直播间业务逻辑
│   │   │       │   ├── CommissionRateService.java         # 分成比例业务逻辑
│   │   │       │   └── Top10RewardService.java            # TOP10统计业务逻辑
│   │   │       ├── repository/
│   │   │       │   ├── AnchorRepository.java              # Anchor数据访问
│   │   │       │   ├── LiveRoomRepository.java            # LiveRoom数据访问
│   │   │       │   └── CommissionRateRepository.java      # CommissionRate数据访问
│   │   │       ├── dto/
│   │   │       │   ├── AnchorDTO.java                     # 主播传输对象
│   │   │       │   ├── LiveRoomDTO.java                   # 直播间传输对象
│   │   │       │   └── CommissionRateDTO.java             # 分成比例传输对象
│   │   │       ├── vo/
│   │   │       │   └── Top10AudienceVO.java               # TOP10观众视图对象
│   │   │       ├── feign/
│   │   │       │   └── AudienceServiceClient.java         # 观众服务调用客户端
│   │   │       ├── task/
│   │   │       │   └── Top10RewardStatisticTask.java      # TOP10定时统计任务
│   │   │       ├── util/
│   │   │       │   └── CacheKeyUtil.java                  # 缓存键生成工具
│   │   │       └── handler/
│   │   │           └── GlobalExceptionHandler.java        # 全局异常处理
│   │   └── resources/
│   │       ├── application.yml                            # Spring配置文件
│   │       ├── application-dev.yml                        # 开发环境配置
│   │       ├── application-prod.yml                       # 生产环境配置
│   │       ├── logback-spring.xml                         # 日志配置
│   │       └── db/
│   │           └── migration/                             # 数据库迁移脚本 (可选)
│   └── test/
│       └── java/
│           └── com/liveroom/anchor/
│               ├── service/
│               ├── controller/
│               └── util/
├── docs/
│   ├── 设计文档.md                                          # 本文档
│   ├── API接口文档.md                                       # REST API规范
│   ├── SQL表结构设计.md                                     # 数据库设计
│   └── 部署指南.md                                          # 部署说明
└── pom.xml                                                  # Maven项目配置
```

---

## 🔌 关键接口设计

### 主播相关接口

```
# 创建主播
POST /anchor/api/v1/anchors
Request:
{
  "nickname": "主播昵称",
  "realName": "真实姓名",
  "gender": 1,
  "birthDate": "1995-01-01",
  "signature": "个人签名"
}
Response:
{
  "code": 0,
  "message": "创建成功",
  "data": {
    "userId": 1,
    "nickname": "主播昵称",
    "anchorLevel": 0,
    "fanCount": 0,
    "verificationStatus": 0
  }
}

# 查询主播信息
GET /anchor/api/v1/anchors/{anchorId}

# 修改主播信息
PUT /anchor/api/v1/anchors/{anchorId}
Request:
{
  "nickname": "新昵称",
  "signature": "新签名"
}

# 查询主播列表
GET /anchor/api/v1/anchors?page=1&size=20&verificationStatus=1&orderBy=fanCount

# 获取主播的可提取余额
GET /anchor/api/v1/anchors/{anchorId}/available-amount

# 更新主播粉丝数/点赞数
PATCH /anchor/api/v1/anchors/{anchorId}/stats
Request:
{
  "fanCountDelta": 5,
  "likeCountDelta": 10
}
```

### 直播间相关接口

```
# 创建直播间
POST /anchor/api/v1/live-rooms
Request:
{
  "anchorId": 1,
  "roomName": "直播间名称",
  "description": "直播间描述",
  "category": "游戏",
  "expectedDuration": 120
}

# 获取主播的直播间
GET /anchor/api/v1/anchors/{anchorId}/live-room

# 开启直播
PUT /anchor/api/v1/live-rooms/{liveRoomId}/start
Request:
{
  "streamUrl": "rtmp://...",
  "coverUrl": "http://..."
}

# 关闭直播
PUT /anchor/api/v1/live-rooms/{liveRoomId}/end

# 更新直播间实时数据
PATCH /anchor/api/v1/live-rooms/{liveRoomId}/realtime
Request:
{
  "currentViewerCount": 1000,
  "currentEarnings": 5000.00
}

# 获取直播间详情
GET /anchor/api/v1/live-rooms/{liveRoomId}
```

### 分成比例相关接口

```
# 设置分成比例
POST /anchor/api/v1/anchors/{anchorId}/commission-rate
Request:
{
  "commissionRate": 50.0,
  "effectiveTime": "2026-01-02T00:00:00",
  "expireTime": null,
  "remark": "调整为50%"
}

# 查询当前生效的分成比例
GET /anchor/api/v1/anchors/{anchorId}/commission-rate/current

# 查询分成比例历史
GET /anchor/api/v1/anchors/{anchorId}/commission-rate/history?page=1&size=20

# 撤销未生效的配置
DELETE /anchor/api/v1/commission-rate/{rateId}
```

### TOP10打赏观众接口

```
# 获取TOP10打赏观众
GET /anchor/api/v1/anchors/{anchorId}/top10-audiences?period=all
参数:
  - period: day(日) | week(周) | month(月) | all(总) [默认: all]

Response:
{
  "code": 0,
  "message": "查询成功",
  "data": [
    {
      "rank": 1,
      "audienceId": 123,
      "audienceNickname": "粉丝名称",
      "totalRechargeAmount": 10000.00,
      "rechargeCount": 50,
      "lastRechargeTime": "2026-01-02T10:00:00"
    }
  ]
}
```

---

## 🔄 核心业务流程

### 1. 主播注册流程
```
主播注册请求
  ↓
验证输入参数 (@Valid注解)
  ↓
检查昵称唯一性
  ↓
创建User实体 + Anchor实体
  ↓
初始化分成比例为默认值(50%)
  ↓
创建默认直播间 (roomStatus=0)
  ↓
记录首次注册时间
  ↓
返回主播信息 + userId
```

### 2. 直播开启流程
```
主播开启直播请求
  ↓
验证主播存在 + 直播间存在
  ↓
检查是否已有进行中的直播 (roomStatus=1)
  ↓
更新直播间状态为 "直播中" (roomStatus=1)
  ↓
记录开播时间(startTime)
  ↓
初始化观众数=0, 营收=0
  ↓
清除Redis缓存中该直播间的旧数据
  ↓
返回直播间信息
```

### 3. 分成比例变更流程
```
修改分成比例请求
  ↓
验证主播存在
  ↓
验证新比例参数 (0-100)
  ↓
检查是否有待生效的配置
  ↓
创建新的CommissionRate记录
  ↓
设置生效时间 (立即或定时)
  ↓
若立即生效，更新Anchor表的commissionRate字段
  ↓
更新时间戳 (update_time)
  ↓
记录操作备注
  ↓
返回配置成功
```

### 4. TOP10打赏观众统计流程
```
定时任务触发 (每小时执行)
  ↓
尝试获取Redis分布式锁
  (key: anchor:{anchorId}:top10:lock, timeout: 30min)
  ↓
锁获取成功?
  ├─ YES → 查询该主播本周期的Recharge记录
  │         按rechargeAmount降序排序
  │         取TOP10
  │         转换为Top10AudienceVO对象
  │         缓存结果到Redis
  │         释放锁
  │         返回成功
  └─ NO  → 放弃执行, 等待下一个周期
```

---

## 💾 缓存策略

### 缓存键设计
| 键 | TTL | 用途 |
|-----|-----|------|
| `anchor:{anchorId}` | 30分钟 | 主播基础信息 |
| `live_room:{liveRoomId}` | 10分钟 | 直播间信息 |
| `anchor:{anchorId}:commission:current` | 24小时 | 当前生效的分成比例 |
| `anchor:{anchorId}:top10_day` | 2小时 | 日榜TOP10 |
| `anchor:{anchorId}:top10_week` | 12小时 | 周榜TOP10 |
| `anchor:{anchorId}:top10_month` | 24小时 | 月榜TOP10 |
| `anchor:{anchorId}:top10_all` | 48小时 | 总榜TOP10 |

### 缓存更新策略
1. **查询操作**: 先查Redis，未命中则查数据库并缓存结果
2. **更新操作**: 更新数据库 → 清除相关缓存
3. **删除操作**: 删除数据库 → 清除相关缓存
4. **批量操作**: 使用lua脚本原子更新缓存

### Cache Aside Pattern
```
查询主播信息:
  ├─ 先查缓存(Redis)
  │   ├─ 命中 → 返回缓存数据
  │   └─ 未命中 → 查询数据库
  └─ 写入缓存(TTL: 30分钟)

修改主播信息:
  ├─ 更新数据库
  └─ 清除缓存(主播信息 + 相关列表)
```

---

## 🔐 服务间通信

### Feign调用观众服务
```java
// AudienceServiceClient.java
@FeignClient(name = "audience-service", fallback = AudienceServiceFallback.class)
public interface AudienceServiceClient {
    
    @PostMapping("/audience/api/v1/recharge/top10")
    BaseResponse<List<Top10AudienceVO>> getTop10Audiences(
        @RequestParam Long anchorId,
        @RequestParam LocalDateTime startTime,
        @RequestParam LocalDateTime endTime
    );
}
```

**超时配置**:
- Feign连接超时: 5000ms
- Feign读取超时: 2000ms
- Hystrix超时: 2000ms
- 断路器阈值: 错误率50%

**降级策略**:
- 返回缓存中的TOP10数据
- 若缓存也无数据，返回空列表

---

## ⏰ 定时任务设计

### Top10RewardStatisticTask
| 属性 | 值 |
|------|-----|
| 执行周期 | 每小时执行一次 |
| 执行时间 | 每小时的第1分钟 |
| 分布式锁 | Redis锁 (key: anchor:{anchorId}:top10:lock) |
| 锁超时 | 30分钟 |
| 失败处理 | 记录日志但不重试，等待下个周期 |
| 统计范围 | 可配置(日/周/月/总) |

```java
@Scheduled(cron = "0 1 * * * ?")  // 每小时第1分钟执行
public void statisticTop10Rewards() {
    // 获取所有启用的主播
    List<Anchor> anchors = anchorRepository.findAllEnabled();
    
    for (Anchor anchor : anchors) {
        String lockKey = "anchor:" + anchor.getUserId() + ":top10:lock";
        
        // 尝试获取分布式锁
        if (redisTemplate.opsForValue().setIfAbsent(lockKey, "1", Duration.ofMinutes(30))) {
            try {
                // 执行TOP10统计
                statisticTop10ByAnchor(anchor.getUserId());
            } finally {
                // 释放锁
                redisTemplate.delete(lockKey);
            }
        }
    }
}
```

---

## 📈 性能指标

| 指标 | 目标值 | 说明 |
|------|-------|------|
| 查询响应时间 | <500ms | 包含缓存查询 |
| 创建响应时间 | <1s | 主播/直播间创建 |
| 修改响应时间 | <800ms | 信息修改 |
| 缓存命中率 | >85% | 热点数据 |
| 服务可用性 | 99.9% | 支持故障转移 |
| 单节点吞吐 | >3000 RPS | 最大请求数/秒 |
| 启动时间 | <30秒 | 无长时间预热 |

---

## 🔒 安全设计

### 1. 接口安全
- **认证**: Token验证 (由Gateway统一处理)
- **授权**: 主播只能修改自己的信息
- **签名验证**: 关键操作 (提取余额等) 需签名验证

### 2. 数据安全
- **敏感信息脱敏**: IP地址、位置信息脱敏展示
- **访问控制**: 私密信息仅本人和管理员可见

### 3. 防重复
- **幂等性**: traceId机制防止重复请求

---

## 🔍 日志与监控

### 日志级别
- **DEBUG**: 方法入参、返回值、本地调试
- **INFO**: 业务关键操作 (创建主播、开启直播、修改比例)
- **WARN**: 业务异常 (重复创建、配置冲突)
- **ERROR**: 系统异常 (数据库错误、服务调用失败)

### 日志格式
```
[日期 时间] [线程ID] [日志级别] [类名] - [traceId] - 日志内容
例: 2026-01-02 10:30:45.123 [http-nio-8081-exec-1] INFO AnchorService - [trace_xxx] - 创建主播成功: userId=123
```

### 监控指标
- **JVM**: 堆内存使用率、GC次数
- **数据库**: 连接池使用率、查询耗时
- **Redis**: 连接数、命中率、内存使用
- **接口**: 调用量、响应时间、错误率
- **业务**: 主播数、活跃直播间数、总营收

---

## 🚀 服务启动流程

```
1. 解析Spring配置 (application.yml + application-dev/prod.yml)
2. 初始化数据源连接池 (HikariCP)
3. 加载Hibernate ORM映射
4. 初始化Redis连接池
5. 创建Spring应用上下文
6. 注册@Bean对象
7. 向Consul注册服务
8. 启动定时任务调度器
9. 初始化Feign客户端
10. 启动Netty服务器 (监听8081端口)
```

**启动时间目标**: <30秒

---

## 📚 相关文档

| 文档 | 链接 | 说明 |
|------|------|------|
| API接口文档 | [API接口文档.md](API接口文档.md) | REST API详细规范 |
| SQL表结构 | [SQL表结构设计.md](SQL表结构设计.md) | 数据库设计 |
| 部署指南 | [部署指南.md](部署指南.md) | 部署和运维 |
| Common模块 | [Common模块文档](../../common/docs/使用指南.md) | 基础设施 |
| 系统整体设计 | [系统设计文档](../../requirements/系统设计文档.md) | 全局架构 |

---

**文档版本**: v1.0  
**最后更新**: 2026-01-02  
**维护者**: Team

