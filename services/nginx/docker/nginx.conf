# Nginx 配置文件
# 用于负载均衡和反向代理微服务

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 20M;

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml application/atom+xml image/svg+xml;

    # ==================== 上游服务器定义 ====================

    # Redis 缓存服务
    upstream redis_service {
        server redis-service:8085 max_fails=2 fail_timeout=30s;
        keepalive 32;
    }

    # 主播服务
    upstream anchor_service {
        server anchor-service:8081 max_fails=2 fail_timeout=30s;
        keepalive 32;
    }

    # 观众服务
    upstream audience_service {
        server audience-service:8082 max_fails=2 fail_timeout=30s;
        keepalive 32;
    }

    # 财务服务
    upstream finance_service {
        server finance-service:8083 max_fails=2 fail_timeout=30s;
        keepalive 32;
    }

    # 数据分析服务
    upstream data_analysis_service {
        server data-analysis-service:8084 max_fails=2 fail_timeout=30s;
        keepalive 32;
    }

    # ==================== 虚拟主机定义 ====================

    server {
        listen 80 default_server;
        server_name localhost;
        
        # ========== Redis 缓存服务路由 ==========
        # 缓存操作接口（9个）:
        #   POST   /redis/api/v1/cache/set                         设置缓存
        #   GET    /redis/api/v1/cache/get                         获取缓存
        #   GET    /redis/api/v1/cache/exists                      检查键存在性
        #   DELETE /redis/api/v1/cache/delete                      删除缓存
        #   POST   /redis/api/v1/cache/expire                      设置过期时间
        #   GET    /redis/api/v1/cache/ttl                         获取剩余过期时间
        #   POST   /redis/api/v1/cache/increment                   递增操作
        #   POST   /redis/api/v1/cache/decrement                   递减操作
        #   GET    /redis/api/v1/cache/health                      健康检查
        #
        # 分布式锁接口（6个）:
        #   POST   /redis/api/v1/lock/try-lock                     尝试获取锁
        #   POST   /redis/api/v1/lock/release-lock                 释放锁
        #   POST   /redis/api/v1/lock/force-release-lock           强制释放锁
        #   GET    /redis/api/v1/lock/is-locked                    检查是否被锁定
        #   GET    /redis/api/v1/lock/get-lock-value               获取锁持有者
        #   POST   /redis/api/v1/lock/check-idempotency            幂等性检查
        #
        # 总计: 15个接口
        location /redis/ {
            proxy_pass http://redis_service;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # ========== 主播服务路由 ==========
        # 主播管理接口（12个）:
        #   POST   /anchor/api/v1/anchors                          创建主播
        #   GET    /anchor/api/v1/anchors/{id}                     查询主播信息
        #   PUT    /anchor/api/v1/anchors/{id}                     修改主播信息
        #   GET    /anchor/api/v1/anchors                          查询主播列表（分页）
        #   GET    /anchor/api/v1/anchors/verification-status/{s}  按认证状态查询
        #   GET    /anchor/api/v1/anchors/search                   搜索主播
        #   PATCH  /anchor/api/v1/anchors/{id}/stats               更新统计数据
        #   PATCH  /anchor/api/v1/anchors/{id}/earnings            更新累计收益
        #   GET    /anchor/api/v1/anchors/{id}/available-amount    查询可提取余额
        #   PATCH  /anchor/api/v1/anchors/{id}/available-amount    更新可提取余额
        #   GET    /anchor/api/v1/anchors/count                    查询主播总数
        #   GET    /anchor/api/v1/anchors/count/verification-status/{s} 按状态统计
        #
        # 直播间管理接口（10个）:
        #   GET    /anchor/api/v1/live-rooms/{id}                  查询直播间信息
        #   GET    /anchor/api/v1/live-rooms/anchor/{anchorId}     按主播查询直播间
        #   POST   /anchor/api/v1/live-rooms/{id}/start            开启直播
        #   POST   /anchor/api/v1/live-rooms/{id}/end              结束直播
        #   PATCH  /anchor/api/v1/live-rooms/{id}/realtime         更新实时数据
        #   GET    /anchor/api/v1/live-rooms/live                  查询正在直播
        #   GET    /anchor/api/v1/live-rooms/category/{cat}        按分类查询
        #   PUT    /anchor/api/v1/live-rooms/{id}                  更新直播间信息
        #   GET    /anchor/api/v1/live-rooms/count/live            统计直播中数量
        #   GET    /anchor/api/v1/live-rooms/count/category/{cat}  按分类统计
        #
        # 直播间实时数据接口（5个）:
        #   POST   /anchor/api/v1/live-rooms/realtime/viewer-enter 观众进入
        #   POST   /anchor/api/v1/live-rooms/realtime/viewer-leave 观众离开
        #   POST   /anchor/api/v1/live-rooms/realtime/danmaku      发送弹幕
        #   POST   /anchor/api/v1/live-rooms/realtime/reward       观众打赏
        #   GET    /anchor/api/v1/live-rooms/realtime/{id}         查询实时数据
        #
        # 分成比例管理接口（2个）:
        #   GET    /anchor/api/v1/commission-rate/{id}/current     查询当前比例
        #   DELETE /anchor/api/v1/commission-rate/{id}/cache       清除缓存
        #
        # 提现管理接口（3个）:
        #   POST   /anchor/api/v1/withdrawal/apply                 申请提现
        #   GET    /anchor/api/v1/withdrawal/list/{anchorId}       查询提现记录
        #   GET    /anchor/api/v1/withdrawal/trace/{traceId}       按traceId查询
        #
        # 打赏记录查询接口（5个）:
        #   GET    /anchor/api/v1/recharge/anchor/{id}             查询主播打赏记录
        #   GET    /anchor/api/v1/recharge/live-room/{id}          查询直播间打赏
        #   GET    /anchor/api/v1/recharge/trace/{traceId}         按traceId查询
        #   GET    /anchor/api/v1/recharge/anchor/{id}/total       统计打赏总额
        #   GET    /anchor/api/v1/recharge/anchor/{id}/top10       查询TOP10观众
        #
        # 总计: 37个接口
        location /anchor/ {
            proxy_pass http://anchor_service;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Trace-Id $http_x_trace_id;
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # ========== 观众服务路由 ==========
        # 观众管理接口（10个）:
        #   POST   /audience/api/v1/audiences                      创建观众账号
        #   POST   /audience/api/v1/audiences/guest                创建游客观众
        #   GET    /audience/api/v1/audiences/{id}                 根据ID查询观众信息
        #   PUT    /audience/api/v1/audiences/{id}                 修改观众信息（昵称/头像等）
        #   GET    /audience/api/v1/audiences                      查询观众列表（分页）
        #   GET    /audience/api/v1/audiences/search               搜索观众
        #   GET    /audience/api/v1/audiences/{id}/consumption-stats 查询观众消费统计
        #   PUT    /audience/api/v1/audiences/{id}/disable         禁用观众账户
        #   PUT    /audience/api/v1/audiences/{id}/enable          启用观众账户
        #
        # 打赏接口（9个）:
        #   POST   /audience/api/v1/recharge                       观众打赏（实时通知直播间）
        #   GET    /audience/api/v1/recharge/{id}                  根据ID查询单条打赏记录
        #   GET    /audience/api/v1/recharge/by-trace-id/{traceId} 根据流水号查询打赏
        #   GET    /audience/api/v1/recharge/anchor/{id}           查询主播收到的打赏记录
        #   GET    /audience/api/v1/recharge/audience/{id}         查询观众的所有打赏记录
        #   GET    /audience/api/v1/recharge/live-room/{id}        查询直播间的打赏记录
        #   GET    /audience/api/v1/recharge/top10                 查询TOP10观众榜单
        #   GET    /audience/api/v1/recharge/unsync                查询待同步打赏记录
        #   PATCH  /audience/api/v1/recharge/{id}/sync             标记打赏记录已同步
        #
        # 测试/同步接口（2个）:
        #   GET    /audience/api/v1/test/sync/queue/status         查询同步队列状态
        #   POST   /audience/api/v1/test/sync/trigger              触发同步任务
        #
        # 总计: 21个接口
        location /audience/ {
            proxy_pass http://audience_service;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Trace-Id $http_x_trace_id;
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # ========== 财务服务路由 ==========
        # 分成比例管理接口（3个）:
        #   POST   /finance/api/v1/commission                      创建/更新主播分成比例配置
        #   GET    /finance/api/v1/commission/{anchorId}/current   查询当前生效的分成比例
        #   GET    /finance/api/v1/commission/{anchorId}/history   查询历史分成配置
        #
        # 结算管理接口（3个）:
        #   GET    /finance/api/v1/settlement/{anchorId}/balance   查询主播余额
        #   GET    /finance/api/v1/settlement/{anchorId}/details   查询结算明细
        #   POST   /finance/api/v1/settlement/trigger              手动触发结算
        #
        # 提现管理接口（5个）:
        #   POST   /finance/api/v1/withdrawal                      创建提现申请
        #   GET    /finance/api/v1/withdrawal/{anchorId}           查询主播的提现列表
        #   GET    /finance/api/v1/withdrawal/by-trace-id/{traceId} 根据流水号查询提现
        #   PUT    /finance/api/v1/withdrawal/{id}/approve         审核通过提现申请
        #   PUT    /finance/api/v1/withdrawal/{id}/reject          审核拒绝提现申请
        #
        # 内部同步接口（2个）:
        #   POST   /finance/internal/sync/recharges                接收批量打赏数据
        #   GET    /finance/internal/sync/progress                 查询同步进度
        #
        # 统计接口（5个）:
        #   GET    /finance/api/finance/statistics/anchor/revenue/{id}      主播收入统计
        #   GET    /finance/api/finance/statistics/anchor/hourly/{id}       主播小时统计
        #   GET    /finance/api/finance/statistics/anchor/top-audiences/{id} 主播TOP观众
        #   POST   /finance/api/finance/statistics/anchor/batch-revenue     批量主播收入
        #   GET    /finance/api/finance/statistics/top-anchors              TOP主播排行
        #
        # 总计: 18个接口
        location /finance/ {
            proxy_pass http://finance_service;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Trace-Id $http_x_trace_id;
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # ========== 数据分析服务路由 ==========
        # 统计分析接口（4个）:
        #   GET    /data-analysis/api/v1/analysis/statistics/gmv-trend           GMV趋势分析
        #   GET    /data-analysis/api/v1/analysis/statistics/key-metrics         关键指标统计
        #   GET    /data-analysis/api/v1/analysis/statistics/time-heatmap        时间热力图
        #   GET    /data-analysis/api/v1/analysis/statistics/category-performance 分类表现分析
        #
        # 排行榜接口（4个）:
        #   GET    /data-analysis/api/v1/analysis/ranking/anchor/income          主播收入排行
        #   GET    /data-analysis/api/v1/analysis/ranking/audience/consumption   观众消费排行
        #   GET    /data-analysis/api/v1/analysis/ranking/anchor/fans            主播粉丝排行
        #   GET    /data-analysis/api/v1/analysis/ranking/live-room/popularity   直播间热度排行
        #
        # 标签分析接口（3个）:
        #   GET    /data-analysis/api/v1/analysis/tag/heatmap                    标签热力图
        #   GET    /data-analysis/api/v1/analysis/tag/related                    关联标签查询
        #   GET    /data-analysis/api/v1/analysis/tag/hot                        热门标签
        #
        # 观众分析接口（4个）:
        #   GET    /data-analysis/api/v1/analysis/audience/{id}/portrait         观众用户画像
        #   GET    /data-analysis/api/v1/analysis/audience/consumption-distribution 消费分布
        #   GET    /data-analysis/api/v1/analysis/audience/retention             用户留存分析
        #   GET    /data-analysis/api/v1/analysis/audience/churn-warning         流失预警
        #
        # 主播分析接口（3个）:
        #   GET    /data-analysis/api/v1/analysis/anchor/{id}/income             主播收入分析
        #   GET    /data-analysis/api/v1/analysis/anchor/{id}/radar              主播雷达图
        #   GET    /data-analysis/api/v1/analysis/anchor/compare                 主播对比分析
        #
        # 手动分析接口（15个）:
        #   POST   /data-analysis/api/v1/analysis/manual/query                   自定义查询
        #   POST   /data-analysis/api/v1/analysis/manual/sync/full               全量数据同步
        #   POST   /data-analysis/api/v1/analysis/manual/sync/incremental        增量数据同步
        #   GET    /data-analysis/api/v1/analysis/manual/custom-range            自定义时间范围分析
        #   GET    /data-analysis/api/v1/analysis/manual/compare-periods         时段对比分析
        #   POST   /data-analysis/api/v1/analysis/manual/cohort-analysis         队列分析
        #   GET    /data-analysis/api/v1/analysis/manual/compare-anchor-groups   主播分组对比
        #   POST   /data-analysis/api/v1/analysis/manual/funnel-analysis         漏斗分析
        #   GET    /data-analysis/api/v1/analysis/manual/anomaly-detection       异常检测
        #   GET    /data-analysis/api/v1/analysis/manual/correlation-analysis    相关性分析
        #   POST   /data-analysis/api/v1/analysis/manual/import-csv              导入CSV数据
        #   POST   /data-analysis/api/v1/analysis/manual/generate-report         生成报表
        #   GET    /data-analysis/api/v1/analysis/manual/prediction              预测分析
        #   DELETE /data-analysis/api/v1/analysis/manual/cache                   清除缓存
        #   GET    /data-analysis/api/v1/analysis/manual/data-quality-check      数据质量检查
        #
        # 分析任务接口（5个）:
        #   POST   /data-analysis/api/v1/analysis/task/trigger/hourly-statistics 触发小时统计
        #   POST   /data-analysis/api/v1/analysis/task/trigger/audience-portrait 触发用户画像
        #   POST   /data-analysis/api/v1/analysis/task/trigger/tag-relation      触发标签关联分析
        #   POST   /data-analysis/api/v1/analysis/task/trigger/retention-analysis 触发留存分析
        #   GET    /data-analysis/api/v1/analysis/task/status                    查询任务状态
        #
        # 总计: 38个接口
        location /data-analysis/ {
            proxy_pass http://data_analysis_service;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Trace-Id $http_x_trace_id;
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # ========== 健康检查 ==========
        location /health {
            access_log off;
            return 200 "OK";
            add_header Content-Type text/plain;
        }

        # ========== 首页 ==========
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
            try_files $uri $uri/ /index.html;
        }
    }

    # HTTPS 配置（生产环境可选）
    # server {
    #     listen 443 ssl;
    #     server_name example.com;
    #
    #     ssl_certificate /etc/nginx/ssl/cert.pem;
    #     ssl_certificate_key /etc/nginx/ssl/key.pem;
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #
    #     # 其他配置...
    # }
}
