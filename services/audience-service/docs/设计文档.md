# 观众服务 (Audience Service) - 系统设计文档

## 📋 文档信息

| 项目 | 内容 |
|------|------|
| **服务名称** | audience-service |
| **服务端口** | 8082 |
| **上下文路径** | /audience |
| **职责** | 观众管理、打赏请求处理、数据同步、用户画像分析 |
| **版本** | 1.0.0 |
| **最后更新** | 2026-01-02 |

---

## 🎯 核心功能

### 1. 观众管理 (Audience Management)

#### 1.1 观众类型
- **注册用户**: 非完整的用户信息，支持长期跟踪，关注和补充信息
- **会员用户**: 完整用户信息，支持会员权益，支持长期跟踪和关注
- **游客用户**: 临时用户，可选填信息，不支持打赏
- **用户转化**: 支持游客转注册用户的流程（保留转换接口）

#### 1.2 基础操作
- **创建观众**: 支持注册用户和游客的创建
- **查询观众**: 单个观众查询、列表查询、搜索功能
- **修改信息**: 更新昵称、性别、年龄、个性签名等
- **状态管理**: 启用/禁用观众账户、加入黑名单等
- **打赏记录**: 存储观众的打赏记录，包含打赏金额、打赏时间、打赏者ID、被打赏者ID

#### 1.3 观众数据统计
- **消费等级**: 根据打赏金额自动划分 (0-低消费、1-中消费、2-高消费)
- **累计消费**: 统计观众的累计打赏金额、打赏次数
- **粉丝等级**: 根据消费等级和打赏频率划分 (0-普通、1-铁粉、2-银粉、3-金粉、4-超级粉丝)
- **最后打赏时间**: 记录最近一次打赏的时间
- **关注数**: 统计观众关注的主播数

### 2. 打赏请求处理 (Recharge Processing)

#### 2.1 打赏接收
- **幂等性保证**: 使用traceId作为唯一标识，防止重复提交
- **参数验证**: 验证金额、主播、观众等必要信息
- **快速响应**: 异步处理，确保接口响应时间<500ms

#### 2.2 打赏流程
```
接收打赏请求
  ↓
生成或获取traceId
  ↓
检查traceId重复 (幂等性)
  ↓
参数验证
  ↓
创建Recharge记录 (status=0: 已入账)
  ↓
异步处理:
  ├─ 更新观众消费统计
  ├─ 更新主播打赏统计
  ├─ 推送数据至财务服务
  └─ 更新直播间实时数据
```

#### 2.3 数据同步
- **同步方式**: 主动推送 (观众服务主动将打赏数据推送至财务服务)
- **批量发送**: 每隔一定时间或达到指定数量时批量同步
- **进度管理**: 使用同步进度表记录已同步的最后一条记录ID
- **断点续传**: 支持失败重试和断点续传

### 3. 观众画像分析 (Audience Profiling)

#### 3.1 消费分析
- **消费金额排序**: 统计全平台所有观众的消费金额，排序得到分位数
- **消费分层**: 
  - 高消费: 前20%
  - 中消费: 20%-80%
  - 低消费: 后20%
- **实时更新**: 定时任务每2小时执行一次分析
- **进度管理**: 每轮更新都记录处理进度，避免重复处理

#### 3.2 标签体系
- **预设标签**: 根据消费水平、关注主播分类等自动生成
- **自定义标签**: 支持用户自定义标签
- **标签关联度**: 维护Tag和TagRelation表，计算标签间关联度
- **标签推荐**: 根据标签关联度为用户推荐相关主播/内容

#### 3.3 用户画像查询
- **调用分析服务**: 通过Feign调用data-analysis-service获取用户画像
- **超时降级**: 超时时间2秒，降级返回缓存或默认值
- **断路器**: 服务故障时自动降级

### 4. 主播TOP10打赏观众查询

#### 4.1 功能
- **数据来源**: 从Recharge表查询该主播的所有打赏记录
- **排序**: 按打赏金额(rechargeAmount)降序，取TOP10
- **缓存**: 结果缓存在Redis，避免重复计算
- **定时更新**: 每小时通过定时任务自动更新

#### 4.2 接口设计
```
GET /audience/api/v1/recharge/top10?anchorId={id}&period={period}
参数:
  - anchorId: 主播ID
  - period: day(日) | week(周) | month(月) | all(总) [默认: all]

响应:
{
  "code": 0,
  "message": "查询成功",
  "data": [
    {
      "rank": 1,
      "audienceId": 123,
      "audienceNickname": "粉丝名称",
      "totalRechargeAmount": 10000.00,
      "rechargeCount": 50
    }
  ]
}
```

---

## 📊 核心数据模型

### 1. Audience (观众)
**继承自**: User  
**表名**: audience  
**主要字段**:
| 字段名 | 类型 | 说明 |
|--------|------|------|
| user_id | BIGINT | 用户ID (主键，FK) |
| ip_location | VARCHAR(256) | IP地理位置 |
| consumption_level | INT | 消费等级 (0-低, 1-中, 2-高) |
| total_recharge_amount | DECIMAL(15,2) | 累计打赏金额 |
| total_recharge_count | BIGINT | 累计打赏次数 |
| last_recharge_time | DATETIME | 最后打赏时间 |
| following_count | BIGINT | 关注主播数 |
| vip_level | INT | 粉丝等级 (0-普通, 1-铁粉, 2-银粉, 3-金粉, 4-超级粉丝) |

**关键索引**: 
- idx_user_id (user_id)
- idx_consumption_level (consumption_level)

### 2. Recharge (打赏记录)
**表名**: recharge  
**主要字段**:
| 字段名 | 类型 | 说明 |
|--------|------|------|
| recharge_id | BIGINT | 打赏ID (主键) |
| live_room_id | BIGINT | 直播间ID (FK) |
| anchor_id | BIGINT | 主播ID (FK) |
| anchor_name | VARCHAR(128) | 主播名称 |
| audience_id | BIGINT | 观众ID (FK) |
| audience_nickname | VARCHAR(128) | 观众昵称 |
| recharge_amount | DECIMAL(15,2) | 打赏金额 |
| recharge_time | DATETIME | 打赏时间 |
| trace_id | VARCHAR(64) | 链路追踪ID (UNIQUE) |
| recharge_type | INT | 打赏类型 (0-普通, 1-礼物等) |
| message | VARCHAR(500) | 打赏消息 |
| status | INT | 状态 (0-已入账, 1-待结算, 2-已结算, 3-已退款) |
| settlement_id | BIGINT | 结算ID (FK) |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

**关键索引**: 
- idx_anchor_id (anchor_id)
- idx_audience_id (audience_id)
- idx_recharge_time (recharge_time)
- idx_trace_id (trace_id) - UNIQUE

### 3. Tag (标签)
**表名**: tag  
**主要字段**:
| 字段名 | 类型 | 说明 |
|--------|------|------|
| tag_id | BIGINT | 标签ID |
| tag_name | VARCHAR(128) | 标签名称 |
| tag_type | INT | 标签类型 (预设/自定义) |
| category | VARCHAR(50) | 分类 |
| create_time | DATETIME | 创建时间 |

### 4. TagRelation (标签关联度)
**表名**: tag_relation  
**主要字段**:
| 字段名 | 类型 | 说明 |
|--------|------|------|
| tag_relation_id | BIGINT | 关联ID |
| tag_id_1 | BIGINT | 标签1 |
| tag_id_2 | BIGINT | 标签2 |
| relevance_score | DOUBLE | 关联度分数 (0-1) |
| update_time | DATETIME | 更新时间 |

### 5. SyncProgress (同步进度表)
**用途**: 记录打赏数据同步至财务服务的进度  
**主要字段**:
| 字段名 | 类型 | 说明 |
|--------|------|------|
| sync_id | BIGINT | 进度ID |
| service_name | VARCHAR(128) | 目标服务名 |
| last_synced_recharge_id | BIGINT | 最后已同步的打赏ID |
| last_sync_time | DATETIME | 最后同步时间 |
| status | INT | 状态 (0-待同步, 1-同步中, 2-完成) |
| update_time | DATETIME | 更新时间 |

---

## 🏗️ 项目结构

```
audience-service/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/liveroom/audience/
│   │   │       ├── AudienceServiceApplication.java       # 启动类
│   │   │       ├── config/
│   │   │       │   ├── RedisConfig.java                 # Redis配置
│   │   │       │   ├── WebConfig.java                   # Web配置
│   │   │       │   └── FeignConfig.java                 # Feign客户端配置
│   │   │       ├── controller/
│   │   │       │   ├── AudienceController.java          # 观众相关接口
│   │   │       │   ├── RechargeController.java          # 打赏相关接口
│   │   │       │   └── ProfileController.java           # 用户画像接口
│   │   │       ├── service/
│   │   │       │   ├── AudienceService.java             # 观众业务逻辑
│   │   │       │   ├── RechargeService.java             # 打赏业务逻辑
│   │   │       │   ├── ProfileService.java              # 用户画像业务逻辑
│   │   │       │   ├── SyncService.java                 # 数据同步业务逻辑
│   │   │       │   └── TagService.java                  # 标签业务逻辑
│   │   │       ├── repository/
│   │   │       │   ├── AudienceRepository.java          # Audience数据访问
│   │   │       │   ├── RechargeRepository.java          # Recharge数据访问
│   │   │       │   ├── TagRepository.java               # Tag数据访问
│   │   │       │   ├── TagRelationRepository.java       # TagRelation数据访问
│   │   │       │   └── SyncProgressRepository.java      # 同步进度数据访问
│   │   │       ├── dto/
│   │   │       │   ├── AudienceDTO.java                 # 观众传输对象
│   │   │       │   ├── RechargeDTO.java                 # 打赏传输对象
│   │   │       │   └── ProfileDTO.java                  # 用户画像传输对象
│   │   │       ├── vo/
│   │   │       │   ├── Top10AudienceVO.java             # TOP10观众视图
│   │   │       │   └── ProfileVO.java                   # 用户画像视图
│   │   │       ├── feign/
│   │   │       │   ├── DataAnalysisServiceClient.java   # 数据分析服务客户端
│   │   │       │   └── FinanceServiceClient.java        # 财务服务客户端
│   │   │       ├── task/
│   │   │       │   ├── RechargeDataSyncTask.java        # 打赏数据同步任务
│   │   │       │   ├── ProfileAnalysisTask.java         # 用户画像分析任务
│   │   │       │   └── TagRelationAnalysisTask.java     # 标签关联度分析任务
│   │   │       ├── util/
│   │   │       │   ├── CacheKeyUtil.java                # 缓存键生成工具
│   │   │       │   └── TraceIdUtil.java                 # TraceId生成工具
│   │   │       └── handler/
│   │   │           └── GlobalExceptionHandler.java      # 全局异常处理
│   │   └── resources/
│   │       ├── application.yml                          # Spring配置
│   │       ├── application-dev.yml                      # 开发环境配置
│   │       ├── application-prod.yml                     # 生产环境配置
│   │       └── logback-spring.xml                       # 日志配置
│   └── test/
│       └── java/
│           └── com/liveroom/audience/
├── docs/
│   ├── 设计文档.md                                        # 本文档
│   ├── API接口文档.md                                     # REST API规范
│   ├── SQL表结构设计.md                                   # 数据库设计
│   └── 部署指南.md                                        # 部署说明
└── pom.xml                                                # Maven项目配置
```

---

## 🔌 关键接口设计

### 观众相关接口

```
# 创建观众 (注册用户)
POST /audience/api/v1/audiences
Request:
{
  "nickname": "观众昵称",
  "realName": "真实姓名",
  "userType": 1,
  "gender": 1,
  "birthDate": "1995-01-01"
}

# 创建游客观众
POST /audience/api/v1/audiences/guest
Request:
{
  "nickname": "游客_{随机ID}"  // 可选
}

# 查询观众信息
GET /audience/api/v1/audiences/{audienceId}

# 修改观众信息
PUT /audience/api/v1/audiences/{audienceId}
Request:
{
  "nickname": "新昵称",
  "signature": "新签名"
}

# 查询观众列表
GET /audience/api/v1/audiences?page=1&size=20&consumptionLevel=2

# 查询观众的打赏记录
GET /audience/api/v1/audiences/{audienceId}/recharges?page=1&size=20

# 查询观众的消费统计
GET /audience/api/v1/audiences/{audienceId}/consumption-stats
Response:
{
  "totalRechargeAmount": 10000.00,
  "totalRechargeCount": 50,
  "consumptionLevel": 2,
  "vipLevel": 3,
  "lastRechargeTime": "2026-01-02T10:00:00"
}

# 关注主播
POST /audience/api/v1/audiences/{audienceId}/follow/{anchorId}

# 取消关注
DELETE /audience/api/v1/audiences/{audienceId}/follow/{anchorId}

# 查询观众关注的主播
GET /audience/api/v1/audiences/{audienceId}/following
```

### 打赏相关接口

```
# 创建打赏记录 (幂等性)
POST /audience/api/v1/recharge
Request:
{
  "liveRoomId": 1,
  "anchorId": 1,
  "anchorName": "主播名称",
  "audienceId": 123,
  "audienceNickname": "观众昵称",
  "rechargeAmount": 100.00,
  "rechargeType": 0,
  "message": "打赏消息",
  "traceId": "trace_xxx"  // 可选，服务端可生成
}
Response:
{
  "code": 0,
  "message": "打赏成功",
  "data": {
    "rechargeId": 1,
    "traceId": "trace_xxx",
    "status": 0
  }
}

# 查询打赏记录
GET /audience/api/v1/recharge/{rechargeId}

# 查询主播的打赏列表
GET /audience/api/v1/recharge/anchor/{anchorId}?page=1&size=20

# 查询直播间的打赏列表
GET /audience/api/v1/recharge/live-room/{liveRoomId}?page=1&size=20

# 查询主播TOP10打赏观众
GET /audience/api/v1/recharge/top10?anchorId={id}&period=all

# 批量查询未同步的打赏记录
GET /audience/api/v1/recharge/unsync?limit=100
Response:
{
  "code": 0,
  "data": [
    { rechargeId, anchorId, audienceId, amount, ... },
    ...
  ]
}

# 标记打赏记录为已同步
PATCH /audience/api/v1/recharge/{rechargeId}/sync
Request:
{
  "status": 1,
  "settlementId": 123
}
```

### 用户画像相关接口

```
# 查询用户消费画像
GET /audience/api/v1/profiles/{audienceId}
Response:
{
  "code": 0,
  "message": "查询成功",
  "data": {
    "audienceId": 123,
    "audienceNickname": "观众昵称",
    "consumptionLevel": 2,
    "consumptionDescription": "高消费用户",
    "totalRechargeAmount": 10000.00,
    "percentile": 0.15,
    "vipLevel": 3,
    "tags": ["直播爱好者", "高消费群体"],
    "relatedAnchors": [...]
  }
}

# 主播查询TOP10打赏观众
GET /audience/api/v1/recharge/anchor/{anchorId}/top10
```

---

## 🔄 核心业务流程

### 1. 观众注册流程
```
注册请求
  ↓
验证参数
  ↓
检查昵称唯一性
  ↓
创建User实体 + Audience实体
  ↓
初始化消费等级=0 (低消费)
  ↓
初始化粉丝等级=0 (普通)
  ↓
记录创建时间
  ↓
返回观众信息 + userId
```

### 2. 打赏流程 (高并发)
```
接收打赏请求 (携带traceId)
  ↓
快速验证参数
  ↓
检查traceId是否已存在 (查Redis缓存)
  │ ├─ 已存在 → 返回缓存中的结果 (幂等性)
  │ └─ 不存在 → 继续
  ↓
创建Recharge记录
  (status=0: 已入账,
   sync_status=0: 待同步,
   trace_id设为唯一索引防重复)
  ↓
返回成功响应 (<500ms)
  ↓
后台异步处理:
  ├─ 更新Audience的消费统计
  ├─ 更新LiveRoom的实时数据
  ├─ 推送至消息队列(可选)
  └─ 加入批量同步队列
```

### 3. 打赏数据同步流程
```
定时任务触发 (每5分钟或积累100条)
  ↓
获取未同步的打赏记录 (sync_status=0)
  ↓
查询SyncProgress表获取同步进度
  ↓
更新SyncProgress状态为 "同步中"
  ↓
调用Feign调用finance-service:
  POST /finance/api/v1/recharge/sync
  Request:
  {
    "records": [
      { rechargeId, anchorId, amount, ... },
      ...
    ]
  }
  ↓
响应成功?
  ├─ YES → 批量更新Recharge记录
  │         sync_status=1 (已同步)
  │         settlement_id=返回的结算ID
  │         更新SyncProgress
  │         记录last_synced_recharge_id
  │         (支持断点续传)
  └─ NO  → 记录日志, 等待下一次重试
```

### 4. 用户画像分析流程
```
定时任务触发 (每2小时)
  ↓
获取全平台Audience的打赏统计
  ↓
按打赏金额总和排序
  ↓
计算分位数:
  ├─ 高消费(前20%) → level=2
  ├─ 中消费(20%-80%) → level=1
  └─ 低消费(后20%) → level=0
  ↓
批量更新Audience的consumption_level
  ↓
根据消费等级和打赏频率计算VIP等级
  ↓
记录分析进度
```

---

## 💾 缓存策略

### 缓存键设计
| 键 | TTL | 用途 |
|-----|-----|------|
| `audience:{audienceId}` | 30分钟 | 观众基础信息 |
| `audience:{audienceId}:recharges` | 10分钟 | 观众打赏列表 |
| `audience:{audienceId}:profile` | 2小时 | 观众消费画像 |
| `recharge:{rechargeId}:idempotent` | 24小时 | 打赏幂等性校验 |
| `anchor:{anchorId}:top10_{period}` | 1小时 | TOP10观众榜单 |

### 缓存更新策略
1. **查询操作**: 先查缓存，未命中则查库并缓存
2. **更新操作**: 更新库 → 清除相关缓存
3. **批量操作**: 使用lua脚本原子操作

---

## 🔐 服务间通信

### Feign调用财务服务
```java
@FeignClient(name = "finance-service", fallback = FinanceServiceFallback.class)
public interface FinanceServiceClient {
    
    @PostMapping("/finance/api/v1/recharge/sync")
    BaseResponse<Map<String, Object>> syncRechargeData(
        @RequestBody SyncRechargeRequest request
    );
}
```

**超时配置**:
- Feign连接超时: 5000ms
- Feign读取超时: 10000ms
- Hystrix超时: 10000ms

### Feign调用数据分析服务
```java
@FeignClient(name = "data-analysis-service", fallback = DataAnalysisServiceFallback.class)
public interface DataAnalysisServiceClient {
    
    @GetMapping("/analysis/api/v1/audiences/{audienceId}/profile")
    BaseResponse<ProfileDTO> getAudienceProfile(
        @PathVariable Long audienceId
    );
}
```

**超时配置**:
- Feign连接超时: 5000ms
- Feign读取超时: 2000ms
- Hystrix超时: 2000ms
- **降级**: 返回缓存或默认画像

---

## ⏰ 定时任务设计

### RechargeDataSyncTask
| 属性 | 值 |
|------|-----|
| 执行周期 | 每5分钟或积累100条记录 |
| 分布式锁 | Redis锁 (sync:audience:recharge) |
| 锁超时 | 30分钟 |
| 批大小 | 100条 |

### ProfileAnalysisTask
| 属性 | 值 |
|------|-----|
| 执行周期 | 每2小时 |
| 执行时间 | 偶数小时的第10分钟 |
| 分布式锁 | Redis锁 (analysis:audience:profile) |
| 处理范围 | 全量观众 |
| 失败处理 | 记录日志，等待下个周期 |

### TagRelationAnalysisTask
| 属性 | 值 |
|------|-----|
| 执行周期 | 每24小时 |
| 执行时间 | 每天凌晨02:00 |
| 分布式锁 | Redis锁 (analysis:tag:relation) |
| 处理范围 | 全量标签 |

---

## 📈 性能指标

| 指标 | 目标值 | 说明 |
|------|-------|------|
| 打赏接口响应 | <500ms | 高并发处理 |
| 查询响应时间 | <500ms | 包含缓存 |
| 修改响应时间 | <800ms | 观众信息修改 |
| 缓存命中率 | >85% | 热点数据 |
| 打赏处理吞吐 | >3000 TPS | 单节点 |
| 数据同步延迟 | <5分钟 | 最终一致性 |
| 服务可用性 | 99.9% | 支持故障转移 |
| 启动时间 | <30秒 | 无长时间预热 |

---

## 🔒 安全设计

### 1. 接口安全
- **认证**: Token验证 (Gateway统一处理)
- **授权**: 观众只能查看/修改自己的数据
- **签名验证**: 关键操作 (打赏) 需签名验证

### 2. 数据安全
- **敏感信息脱敏**: IP地址、位置脱敏
- **访问控制**: 消费画像仅本人和主播可见

### 3. 防重复
- **幂等性**: traceId作为唯一键
- **Redis缓存**: 24小时内的重复请求直接返回缓存

### 4. 防暴力
- **限流**: 单个观众打赏频率限制
- **黑名单**: 异常账户加入黑名单

---

## 🔍 日志与监控

### 日志级别
- **DEBUG**: 方法参数、返回值、缓存命中情况
- **INFO**: 业务关键操作 (注册、打赏、同步)
- **WARN**: 业务异常 (重复打赏、同步失败)
- **ERROR**: 系统异常 (数据库错误、服务调用失败)

### 日志格式
```
[日期 时间] [线程ID] [日志级别] [类名] - [traceId] - 日志内容
例: 2026-01-02 10:30:45.123 [pool-1-thread-1] INFO RechargeService - [trace_xxx] - 打赏成功: amount=100, anchorId=1
```

### 监控指标
- **JVM**: 堆内存、GC频率
- **数据库**: 连接池使用率、慢查询
- **缓存**: Redis内存、命中率、发布订阅通道数
- **接口**: 打赏接口吞吐(TPS)、响应时间分布
- **业务**: 日均打赏总额、日活观众数、平均打赏金额

---

## 🚀 服务启动流程

```
1. 加载配置 (application.yml)
2. 初始化数据源 (HikariCP)
3. 加载ORM映射
4. 初始化Redis连接
5. 创建Spring上下文
6. 注册Bean对象
7. 向Consul注册服务
8. 启动定时任务调度器
9. 初始化Feign客户端
10. 启动Netty服务器 (8082)
```

**启动时间目标**: <30秒

---

## 📚 相关文档

| 文档 | 链接 | 说明 |
|------|------|------|
| API接口文档 | [API接口文档.md](API接口文档.md) | REST API详细规范 |
| SQL表结构 | [SQL表结构设计.md](SQL表结构设计.md) | 数据库设计 |
| 部署指南 | [部署指南.md](部署指南.md) | 部署和运维 |
| Common模块 | [Common模块文档](../../common/docs/使用指南.md) | 基础设施 |
| 系统整体设计 | [系统设计文档](../../requirements/系统设计文档.md) | 全局架构 |

---

**文档版本**: v1.0  
**最后更新**: 2026-01-02  
**维护者**: Team

