# ğŸ”„ ä»æ—§ä»£ç è¿ç§»åˆ°æ–°æ•°æ®è®¿é—®å±‚æŒ‡å—

## ğŸ“Œ æ¦‚è¿°

æœ¬æ–‡æ¡£æŒ‡å¯¼å¦‚ä½•å°†ç°æœ‰å¾®æœåŠ¡çš„æ•°æ®è®¿é—®ä»£ç è¿ç§»åˆ°ç»Ÿä¸€çš„ Common æ•°æ®è®¿é—®å±‚ã€‚

**è¿ç§»ç›®æ ‡ï¼š**
- âœ… æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½é€šè¿‡ Common æ¨¡å—
- âœ… ç»Ÿä¸€ä½¿ç”¨ç¼“å­˜ç­–ç•¥
- âœ… ç»Ÿä¸€æ•°æ®æ ¼å¼
- âœ… ç»Ÿä¸€äº‹åŠ¡ç®¡ç†

---

## ğŸ” è¿ç§»æ£€æŸ¥æ¸…å•

åœ¨å¼€å§‹è¿ç§»å‰ï¼Œè¯·ç¡®ä¿ï¼š

- [ ] äº†è§£å½“å‰ä»£ç çš„æ•°æ®è®¿é—®æ–¹å¼
- [ ] å¤‡ä»½ç°æœ‰ä»£ç 
- [ ] å‡†å¤‡å¥½æ–°çš„å•å…ƒæµ‹è¯•
- [ ] æœ‰æ—¶é—´è¿›è¡Œå……åˆ†çš„æµ‹è¯•

---

## ğŸ“– è¿ç§»æ­¥éª¤

### ç¬¬ 1 æ­¥ï¼šæ·»åŠ ä¾èµ–

åœ¨ä½ çš„å¾®æœåŠ¡ `pom.xml` ä¸­ç¡®ä¿å·²æœ‰ Common ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.liveroom</groupId>
    <artifactId>common</artifactId>
    <version>1.0.0</version>
</dependency>
```

---

### ç¬¬ 2 æ­¥ï¼šæ›¿æ¢ä¾èµ–æ³¨å…¥

#### âŒ æ—§æ–¹å¼ï¼ˆç›´æ¥æ³¨å…¥ Repository/Mapperï¼‰

```java
@RestController
public class UserController {
    
    @Autowired
    private UserRepository userRepository;  // ä¸è¦è¿™æ ·åš
    
    @Autowired
    private UserMapper userMapper;  // ä¹Ÿä¸è¦è¿™æ ·åš
    
    @GetMapping("/user/{id}")
    public User getUser(@PathVariable Long id) {
        return userRepository.findById(id).orElse(null);
    }
}
```

#### âœ… æ–°æ–¹å¼ï¼ˆä½¿ç”¨ DataAccessFacadeï¼‰

```java
import common.service.DataAccessFacade;

@RestController
public class UserController {
    
    @Autowired
    private DataAccessFacade dataAccessFacade;  // ç»Ÿä¸€å…¥å£
    
    @GetMapping("/user/{id}")
    public User getUser(@PathVariable Long id) {
        return dataAccessFacade.user()
            .findById(id)
            .orElse(null);
    }
}
```

---

### ç¬¬ 3 æ­¥ï¼šé€ä¸ªè¿ç§»æ–¹æ³•

#### åœºæ™¯ 1ï¼šç®€å•æŸ¥è¯¢

**âŒ æ—§ä»£ç ï¼š**
```java
// ç›´æ¥ä½¿ç”¨ Repository
User user = userRepository.findById(id).orElse(null);
List<User> users = userRepository.findAll();
Page<User> page = userRepository.findAll(PageRequest.of(0, 20));
```

**âœ… æ–°ä»£ç ï¼š**
```java
// ä½¿ç”¨ DataAccessFacade
User user = dataAccessFacade.user()
    .findById(id)
    .orElse(null);
List<User> users = dataAccessFacade.user()
    .findAll();
Page<User> page = dataAccessFacade.user()
    .findPage(1, 20);
```

#### åœºæ™¯ 2ï¼šæ¡ä»¶æŸ¥è¯¢

**âŒ æ—§ä»£ç ï¼š**
```java
// MyBatis Mapper
List<User> activeUsers = userMapper.selectByType(1);
User byEmail = userRepository.findByEmail(email).orElse(null);
```

**âœ… æ–°ä»£ç ï¼š**
```java
// ç»Ÿä¸€é€šè¿‡ Service å±‚æŸ¥è¯¢
List<User> activeUsers = dataAccessFacade.user()
    .findActiveUsersByType(1);
User byEmail = dataAccessFacade.user()
    .findByEmail(email)
    .orElse(null);
```

#### åœºæ™¯ 3ï¼šåˆ›å»ºå’Œæ›´æ–°

**âŒ æ—§ä»£ç ï¼š**
```java
// ç›´æ¥è°ƒç”¨ mapper
userMapper.insert(user);
userMapper.updateById(user);
userRepository.save(user);
```

**âœ… æ–°ä»£ç ï¼š**
```java
// é€šè¿‡ Serviceï¼ˆè‡ªåŠ¨å¤„ç†ç¼“å­˜ï¼‰
User savedUser = dataAccessFacade.user()
    .createUser(user);  // åˆ›å»º
User updatedUser = dataAccessFacade.user()
    .updateUser(user);  // æ›´æ–°
```

#### åœºæ™¯ 4ï¼šåˆ é™¤æ“ä½œ

**âŒ æ—§ä»£ç ï¼š**
```java
userRepository.deleteById(id);
userRepository.delete(user);
userMapper.deleteByIds(ids);
```

**âœ… æ–°ä»£ç ï¼š**
```java
dataAccessFacade.user()
    .deleteUser(id);  // å•æ¡åˆ é™¤

dataAccessFacade.user()
    .batchDeleteUsers(ids);  // æ‰¹é‡åˆ é™¤
```

#### åœºæ™¯ 5ï¼šæ‰¹é‡æ“ä½œ

**âŒ æ—§ä»£ç ï¼ˆä½æ•ˆï¼‰ï¼š**
```java
for (User user : users) {
    userRepository.save(user);  // N æ¬¡æ•°æ®åº“æ“ä½œï¼
}
```

**âœ… æ–°ä»£ç ï¼ˆé«˜æ•ˆï¼‰ï¼š**
```java
dataAccessFacade.user()
    .batchSaveUsers(users);  // 1 æ¬¡æ•°æ®åº“æ“ä½œ
```

#### åœºæ™¯ 6ï¼šäº‹åŠ¡å¤„ç†

**âŒ æ—§ä»£ç ï¼š**
```java
@Transactional
public void registerUser(User user, Audience audience) {
    userRepository.save(user);
    audienceRepository.save(audience);
    // å¦‚æœåç»­æ“ä½œå¤±è´¥ï¼Œä¼šè‡ªåŠ¨å›æ»š
}
```

**âœ… æ–°ä»£ç ï¼ˆæ›´æ¸…æ™°ï¼‰ï¼š**
```java
public void registerUser(User user, Audience audience) {
    dataAccessFacade.beginBatchOperation(facade -> {
        facade.user().createUser(user);
        facade.audience().createAudience(audience);
        // è‡ªåŠ¨åœ¨äº‹åŠ¡å†…ï¼Œå‡ºé”™è‡ªåŠ¨å›æ»š
    });
}
```

---

### ç¬¬ 4 æ­¥ï¼šè¿ç§»ç‰¹æ®Šä¸šåŠ¡é€»è¾‘

#### æ‰“èµä¸šåŠ¡ï¼ˆæ¶‰åŠå¹‚ç­‰æ€§ï¼‰

**âŒ æ—§ä»£ç ï¼š**
```java
@Transactional
public void createRecharge(Recharge recharge) {
    // å¯èƒ½å­˜åœ¨é‡å¤æäº¤çš„é—®é¢˜
    rechargeRepository.save(recharge);
}
```

**âœ… æ–°ä»£ç ï¼ˆå¸¦å¹‚ç­‰æ€§ï¼‰ï¼š**
```java
public void createRecharge(Recharge recharge) {
    // è‡ªåŠ¨é˜²é‡å¤
    Recharge result = dataAccessFacade.recharge()
        .createRecharge(recharge);
    
    // å¦‚æœ traceId é‡å¤ï¼Œä¼šè‡ªåŠ¨è¿”å›å·²å­˜åœ¨çš„è®°å½•
}
```

#### ç»“ç®—ä¸šåŠ¡ï¼ˆæ¶‰åŠèšåˆï¼‰

**âŒ æ—§ä»£ç ï¼š**
```java
// æ‰‹åŠ¨è®¡ç®—
BigDecimal total = BigDecimal.ZERO;
for (Recharge r : recharges) {
    total = total.add(r.getRechargeAmount());
}
```

**âœ… æ–°ä»£ç ï¼ˆä½¿ç”¨ Service æ–¹æ³•ï¼‰ï¼š**
```java
// ç›´æ¥è°ƒç”¨
BigDecimal total = dataAccessFacade.recharge()
    .sumRechargeByAnchor(anchorId);
```

---

## ğŸ“ å¸¸è§è¿ç§»åœºæ™¯

### åœºæ™¯ Aï¼šAudience Service è¿ç§»

**å½“å‰çŠ¶æ€ï¼š** ä½¿ç”¨ AudienceMapper å’Œéƒ¨åˆ† Service

```java
// âŒ æ—§çš„ AudienceService
@Service
public class AudienceService {
    @Autowired
    private AudienceMapper audienceMapper;
    
    public void addRechargeAmount(Long audienceId, BigDecimal amount) {
        audienceMapper.incrementRechargeAmount(audienceId, amount);
    }
}
```

**è¿ç§»åï¼š**

```java
// âœ… æ–°çš„ AudienceController/Service
@RestController
public class AudienceController {
    @Autowired
    private DataAccessFacade dataAccessFacade;
    
    public void addRechargeAmount(Long audienceId, BigDecimal amount) {
        dataAccessFacade.audience()
            .incrementRecharge(audienceId, amount, 1L);
    }
}
```

### åœºæ™¯ Bï¼šFinance Service è¿ç§»

**å½“å‰çŠ¶æ€ï¼š** æ··åˆä½¿ç”¨ Mapper å’Œ Repository

```java
// âŒ å¤šä¸ªæ•°æ®æºæ··ç”¨
@Service
public class SettlementService {
    @Autowired
    private RechargeMapper rechargeMapper;  // DB1
    @Autowired
    private SettlementRepository settlementRepository;  // DB2
    
    public void settle(Long anchorId) {
        // æ‰‹åŠ¨åŒæ­¥æ•°æ®
        List<Recharge> unsettled = rechargeMapper.selectUnsettled(anchorId);
        BigDecimal amount = unsettled.stream()
            .map(Recharge::getAmount)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
        
        Settlement settlement = settlementRepository
            .findByAnchorId(anchorId)
            .orElse(null);
        // ... æ›´æ–°é€»è¾‘
    }
}
```

**è¿ç§»åï¼š**

```java
// âœ… ç»Ÿä¸€é€šè¿‡ Common è®¿é—®
@Service
public class SettlementService {
    @Autowired
    private DataAccessFacade dataAccessFacade;
    
    public void settle(Long anchorId) {
        // ç›´æ¥ä½¿ç”¨å·²æœ‰çš„è®¡ç®—æ–¹æ³•
        BigDecimal amount = dataAccessFacade.recharge()
            .sumRechargeByAnchor(anchorId);
        
        dataAccessFacade.settlement()
            .incrementAvailableAmount(anchorId, amount);
    }
}
```

---

## âœ… è¿ç§»éªŒè¯æ¸…å•

å®Œæˆè¿ç§»åï¼Œè¯·ä¾æ¬¡éªŒè¯ï¼š

- [ ] æ‰€æœ‰ä»£ç éƒ½ä½¿ç”¨ DataAccessFacade
- [ ] æ²¡æœ‰ç›´æ¥çš„ Repository æˆ– Mapper æ³¨å…¥
- [ ] å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] ç¼“å­˜å‘½ä¸­ç‡æ­£å¸¸ï¼ˆ> 80%ï¼‰
- [ ] æ•°æ®åº“è¿æ¥æ•°æ­£å¸¸
- [ ] æ²¡æœ‰å‡ºç°é‡å¤æäº¤é—®é¢˜

---

## ğŸ§ª æµ‹è¯•è¿ç§»

### å•å…ƒæµ‹è¯•è¿ç§»

**âŒ æ—§æµ‹è¯•ï¼š**
```java
@Test
public void testSaveUser() {
    User user = new User();
    user.setUsername("test");
    User saved = userRepository.save(user);
    
    assertNotNull(saved.getId());
}
```

**âœ… æ–°æµ‹è¯•ï¼š**
```java
@Test
public void testSaveUser() {
    DataAccessFacade dataAccessFacade = context.getBean(DataAccessFacade.class);
    
    User user = new User();
    user.setUsername("test");
    User saved = dataAccessFacade.user()
        .createUser(user);
    
    assertNotNull(saved.getId());
    
    // éªŒè¯ç¼“å­˜
    Optional<User> cached = dataAccessFacade.user()
        .findById(saved.getId());
    assertTrue(cached.isPresent());
}
```

---

## ğŸ“Š è¿ç§»è¿›åº¦è·Ÿè¸ª

å»ºè®®æŒ‰ç…§ä»¥ä¸‹é¡ºåºè¿ç§»ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š

| ä¼˜å…ˆçº§ | æ¨¡å— | è¿ç§»å¤æ‚åº¦ | é¢„è®¡å·¥ä½œé‡ |
|-------|------|----------|---------|
| 1 | audience-service | ä½ | 4h |
| 2 | finance-service | ä¸­ | 6h |
| 3 | anchor-service | ä½ | 3h |
| 4 | back_end-service | ä¸­ | 5h |
| 5 | mock-service | ä½ | 2h |
| 6 | data-analysis-service | é«˜ | 8h |

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q1: ç¼“å­˜ä¸æ›´æ–°æ€ä¹ˆåŠï¼Ÿ

**A:** Service çš„æ‰€æœ‰ä¿®æ”¹æ–¹æ³•éƒ½è‡ªåŠ¨æ¸…é™¤ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚å¦‚éœ€æ‰‹åŠ¨æ¸…é™¤ï¼š

```java
dataAccessFacade.clearAllCache();
```

### Q2: å¦‚ä½•å¤„ç†å¤æ‚çš„ä¸šåŠ¡æŸ¥è¯¢ï¼Ÿ

**A:** å¦‚æœ Service æ²¡æœ‰æä¾›æŸä¸ªæŸ¥è¯¢æ–¹æ³•ï¼Œå¯ä»¥ï¼š

1. å…ˆé€šè¿‡ Service æŸ¥è¯¢å…³é”®æ•°æ®
2. åœ¨åº”ç”¨å±‚è¿›è¡Œç»„è£…

```java
List<Anchor> anchors = dataAccessFacade.anchor()
    .findAll();

// åœ¨åº”ç”¨å±‚è¿›è¡ŒäºŒæ¬¡å¤„ç†
List<AnchorDTO> dtos = anchors.stream()
    .filter(a -> a.getFanCount() > 1000)
    .map(this::convertToDTO)
    .collect(Collectors.toList());
```

æˆ–è€…ï¼Œå‘ Common æ¨¡å—æäº¤ Issueï¼Œæ·»åŠ æ–°çš„ Repository æŸ¥è¯¢æ–¹æ³•ã€‚

### Q3: æ‰¹é‡æ“ä½œçš„æœ€å¤§é™åˆ¶æ˜¯å¤šå°‘ï¼Ÿ

**A:** å»ºè®®å•æ¬¡ä¸è¶…è¿‡ 1000 æ¡ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨æ‹†åˆ†ä¸º 500 æ¡ä¸€æ‰¹å¤„ç†ã€‚

### Q4: å¦‚ä½•ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡ï¼Ÿ

**A:** é€šè¿‡ Redis ç›‘æ§å·¥å…·ï¼ˆå¦‚ Redis Commanderï¼‰æŸ¥çœ‹ï¼š

```
INFO stats
# æŸ¥çœ‹ keyspace_hits å’Œ keyspace_misses
```

---

## ğŸ“ è¿ç§»æ£€æŸ¥è¡¨

é€ä¸ªæ¨¡å—æ£€æŸ¥å¹¶æ ‡è®°å®Œæˆï¼š

```
[ ] audience-service
  [ ] Controller è¿ç§»
  [ ] Service è¿ç§»
  [ ] å•å…ƒæµ‹è¯•
  [ ] é›†æˆæµ‹è¯•

[ ] finance-service
  [ ] Controller è¿ç§»
  [ ] Service è¿ç§»
  [ ] å•å…ƒæµ‹è¯•
  [ ] é›†æˆæµ‹è¯•

[ ] anchor-service
  [ ] Controller è¿ç§»
  [ ] Service è¿ç§»
  [ ] å•å…ƒæµ‹è¯•
  [ ] é›†æˆæµ‹è¯•

... å…¶ä»–æ¨¡å—
```

---

## ğŸ¯ è¿ç§»å®Œæˆæ ‡å‡†

è¿ç§»å®Œæˆæ—¶åº”æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

âœ… æ‰€æœ‰æ¨¡å—éƒ½ä½¿ç”¨ DataAccessFacade  
âœ… æ²¡æœ‰ç›´æ¥çš„ Repository æˆ– Mapper æ³¨å…¥  
âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡  
âœ… æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡  
âœ… ä»£ç å®¡æŸ¥é€šè¿‡  
âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡ï¼ˆä¸è¿ç§»å‰æŒå¹³ï¼‰  
âœ… ç¼“å­˜å‘½ä¸­ç‡ > 80%  

---

## ğŸ’¡ è¿ç§»æœ€ä½³å®è·µ

1. **é€æ­¥è¿ç§»** - ä¸è¦ä¸€æ¬¡æ€§å…¨éƒ¨è¿ç§»ï¼Œå…ˆè¿ç§»ä¸€ä¸ªæ¨¡å—éªŒè¯
2. **ä¿ç•™å¤‡ä»½** - ä¿ç•™æ—§ä»£ç çš„å¤‡ä»½åˆ†æ”¯ï¼Œä»¥é˜²éœ€è¦å›æ»š
3. **å……åˆ†æµ‹è¯•** - æ¯ä¸ªæ¨¡å—è¿ç§»åéƒ½è¦å®Œæ•´æµ‹è¯•
4. **æ€§èƒ½ç›‘æ§** - è¿ç§»å‰åå¯¹æ¯”æ€§èƒ½æŒ‡æ ‡
5. **æ–‡æ¡£æ›´æ–°** - åŠæ—¶æ›´æ–°å›¢é˜Ÿæ–‡æ¡£å’Œå¼€å‘æŒ‡å—
6. **çŸ¥è¯†åˆ†äº«** - å‘å›¢é˜Ÿåˆ†äº«è¿ç§»ç»éªŒ

---

æœ€åæ›´æ–°ï¼š2026å¹´1æœˆ6æ—¥  
ç‰ˆæœ¬ï¼š1.0.0
