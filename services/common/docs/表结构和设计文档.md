# 📋 数据库表结构和设计文档

## 🗄️ 数据库架构

系统使用**两个独立的数据库**：

```
Live System Database Architecture
│
├── live_audience_db (DB1 - 观众服务)
│   ├── user              # 用户基础表（继承表）
│   ├── anchor            # 主播信息表
│   ├── audience          # 观众信息表
│   ├── live_room         # 直播间表
│   ├── live_room_realtime # 直播间实时数据
│   ├── live_session_audience # 直播会话观众
│   ├── message           # 弹幕消息表
│   ├── recharge          # 打赏记录表（核心业务）
│   ├── tag               # 标签表
│   ├── anchor_tag        # 主播-标签关联
│   ├── audience_tag      # 观众-标签关联
│   ├── live_room_tag     # 直播间-标签关联
│   └── sync_progress     # 数据同步进度
│
└── live_finance_db (DB2 - 财务服务)
    ├── commission_rate   # 分成比例表
    ├── settlement        # 结算表
    ├── settlement_detail # 结算明细表
    ├── withdrawal        # 提现记录表
    ├── recharge_record   # 打赏记录(财务侧)
    ├── hourly_statistics # 小时统计表
    ├── audience_portrait # 观众画像表
    └── sync_progress     # 数据同步进度
```

---

## 📊 核心表设计详解

### 1. User 表（用户基础表）

**用途：** 存储所有用户信息，支持继承关系

**设计特点：**
- 使用 JOINED 继承策略（Anchor 和 Audience 继承此表）
- userType 作为鉴别列，用于确定用户类型
- 支持游客用户（userType=0）

**关键字段：**
```sql
user_id          BIGINT          主键，自增
user_type        INT             0-游客、1-注册用户、2-主播、3-观众 （实际继承自表）
username         VARCHAR(64)     用户名（UNIQUE，注册用户）
email            VARCHAR(128)    邮箱（UNIQUE）
password_hash    VARCHAR(255)    密码哈希值
account_status   INT             0-正常、1-禁用、2-禁言、3-封禁
is_deleted       INT             0-未删除、1-已删除（软删除）
```

**索引：**
```sql
idx_user_type        # 按用户类型查询
idx_username         # 用户名唯一性和查询
idx_account_status   # 查询禁用/禁言用户
idx_create_time      # 按创建时间排序
```

**查询示例：**
```sql
-- 查询所有注册用户
SELECT * FROM user WHERE user_type = 1 AND is_deleted = 0;

-- 查询特定用户名
SELECT * FROM user WHERE username = ? AND is_deleted = 0;

-- 查询被封禁的用户
SELECT * FROM user WHERE account_status IN (2, 3) AND user_type = 1;
```

---

### 2. Anchor 表（主播信息表）

**用途：** 存储主播特定信息（粉丝数、收益、等级等）

**设计特点：**
- 与 User 表通过 user_id 一一对应
- 与 live_room 表一一对应
- 存储计算型数据（粉丝数、收益），通过结算表同步

**关键字段：**
```sql
user_id              BIGINT         主键，外键指向 user
live_room_id         BIGINT         一一对应的直播间
anchor_level         INT            主播等级（影响分成）
fan_count            BIGINT         粉丝数（可调），累计数值
like_count           BIGINT         点赞数
available_amount     DECIMAL(15,2)  可提取余额（实时）
total_earnings       DECIMAL(15,2)  累计收益（计算值）
current_commission_rate DECIMAL(5,2) 当前分成比例
banned_until         DATETIME       封禁截止时间
```

**索引：**
```sql
idx_live_room_id     # 直播间反向查询
idx_fan_count        # 粉丝数排序
idx_total_earnings   # 收益排序
```

**查询示例：**
```sql
-- 查询粉丝数最多的 10 个主播
SELECT * FROM anchor ORDER BY fan_count DESC LIMIT 10;

-- 查询收益最多的主播
SELECT * FROM anchor ORDER BY total_earnings DESC LIMIT 20;

-- 查询有可提取余额的主播
SELECT * FROM anchor WHERE available_amount > 0;
```

---

### 3. Audience 表（观众信息表）

**用途：** 存储观众特定信息（消费等级、打赏金额等）

**设计特点：**
- 与 User 表通过 user_id 一一对应
- 消费等级通过分析任务定期更新
- 支持粉丝等级（VIP 体系）

**关键字段：**
```sql
user_id                  BIGINT         主键，外键指向 user
consumption_level        INT            0-低、1-中、2-高（后20%、中60%、前20%）
total_recharge_amount    DECIMAL(15,2)  累计打赏金额
total_recharge_count     BIGINT         累计打赏次数
last_recharge_time       DATETIME       最后打赏时间
vip_level                INT            0-普通、1-铁粉、2-银粉、3-金粉、4-超级粉丝
```

**索引：**
```sql
idx_consumption_level    # 按消费等级查询
idx_total_recharge_amount # 打赏金额排序
idx_last_recharge_time   # 最后打赏时间查询
```

**查询示例：**
```sql
-- 查询高消费观众（前 20%）
SELECT * FROM audience WHERE consumption_level = 2;

-- 查询消费金额最多的观众
SELECT * FROM audience ORDER BY total_recharge_amount DESC LIMIT 20;

-- 查询月活（最近 30 天有打赏）
SELECT * FROM audience 
WHERE last_recharge_time >= DATE_SUB(NOW(), INTERVAL 30 DAY);
```

---

### 4. Live_Room 表（直播间表）

**用途：** 存储直播间基本信息和统计数据

**设计特点：**
- 与 Anchor 表一一对应
- room_status 记录直播状态变迁
- 累计数据（总观众、总收益）

**关键字段：**
```sql
live_room_id       BIGINT         主键，自增
anchor_id          BIGINT         主播 ID（UNIQUE）
room_name          VARCHAR(255)   直播间名称
description        VARCHAR(1000)  描述
room_status        INT            0-未开播、1-直播中、2-已结束、3-被封禁
category           VARCHAR(50)    分类：游戏、娱乐、户外等
cover_url          VARCHAR(500)   封面图
stream_url         VARCHAR(500)   流地址
max_viewers        INT            最大容纳人数（通常 10000）
start_time         DATETIME       上次开播时间
end_time           DATETIME       上次关播时间
total_earnings     DECIMAL(15,2)  累计收益
total_viewers      BIGINT         累计观看人次
```

**索引：**
```sql
idx_anchor_id      # 主播查询直播间
idx_room_status    # 查询直播中的房间
idx_category       # 按分类查询
idx_start_time     # 时间排序
```

**查询示例：**
```sql
-- 查询直播中的所有直播间
SELECT * FROM live_room WHERE room_status = 1;

-- 查询某分类下观众最多的直播间
SELECT * FROM live_room 
WHERE category = 'game' AND room_status = 1
ORDER BY total_viewers DESC LIMIT 10;

-- 查询最近开播的 10 个直播间
SELECT * FROM live_room 
ORDER BY start_time DESC LIMIT 10;
```

---

### 5. Recharge 表（打赏记录表 - 核心业务）

**用途：** 记录所有打赏行为，是结算和财务的数据来源

**设计特点：**
- **核心业务表**，需要确保数据一致性
- traceId 用于幂等性控制（防重复）
- 支持打赏类型（普通、礼物、特殊）
- status 记录结算状态转移

**关键字段：**
```sql
recharge_id        BIGINT         主键，自增
live_room_id       BIGINT         直播间 ID
anchor_id          BIGINT         主播 ID
audience_id        BIGINT         观众 ID
recharge_amount    DECIMAL(15,2)  打赏金额
recharge_type      INT            0-普通、1-礼物、2-特殊
trace_id           VARCHAR(64)    幂等性控制（UNIQUE）
status             INT            0-已入账、1-待结算、2-已结算、3-已退款
settlement_id      BIGINT         对应的结算 ID
recharge_time      DATETIME       打赏时间（业务时间）
```

**索引：**
```sql
uk_trace_id        # 幂等性控制
idx_live_room_id   # 直播间查询
idx_anchor_id      # 主播查询
idx_audience_id    # 观众查询
idx_recharge_time  # 时间范围查询
idx_status         # 结算状态查询
```

**重要约束：**
```sql
FOREIGN KEY (anchor_id) REFERENCES anchor(user_id)
FOREIGN KEY (audience_id) REFERENCES audience(user_id)
FOREIGN KEY (live_room_id) REFERENCES live_room(live_room_id)
```

**查询示例：**
```sql
-- 查询特定主播的未结算打赏
SELECT * FROM recharge 
WHERE anchor_id = ? AND status IN (0, 1)
ORDER BY recharge_time ASC;

-- 查询时间范围内的打赏总额（用于结算）
SELECT SUM(recharge_amount) as total_amount,
       COUNT(*) as count
FROM recharge
WHERE anchor_id = ? 
  AND recharge_time BETWEEN ? AND ?
  AND status != 3;  -- 排除退款

-- 检查 traceId 是否存在（防重复）
SELECT 1 FROM recharge WHERE trace_id = ? LIMIT 1;
```

---

### 6. Settlement 表（结算表）

**用途：** 记录主播的结算信息（可提取余额等）

**设计特点：**
- 与 Anchor 表一一对应
- available_amount 是观众到账金额减去已提现金额
- 支持结算冻结（status=1）和禁提（status=2）

**关键字段：**
```sql
settlement_id           BIGINT         主键，自增
anchor_id               BIGINT         主播 ID（UNIQUE）
settlement_amount       DECIMAL(15,2)  结算总金额
withdrawn_amount        DECIMAL(15,2)  已提取金额
available_amount        DECIMAL(15,2)  可提取 = 结算 - 已提取
settlement_cycle        INT            结算周期（天数，通常 1 天）
last_settlement_time    DATETIME       上次结算时间
next_settlement_time    DATETIME       下次结算时间
status                  INT            0-正常、1-冻结、2-禁提
```

**索引：**
```sql
idx_anchor_id          # 主播查询
idx_status             # 查询冻结/禁提
idx_next_settlement_time # 定时任务查询
```

**更新逻辑：**
```
available_amount = settlement_amount - withdrawn_amount
    
当有新打赏时：
  settlement_amount += 打赏金额
  available_amount += 打赏金额
  
当主播提现时：
  withdrawn_amount += 提现金额
  available_amount -= 提现金额
```

**查询示例：**
```sql
-- 查询可提取金额
SELECT available_amount FROM settlement WHERE anchor_id = ?;

-- 查询待结算的主播
SELECT * FROM settlement 
WHERE next_settlement_time <= NOW()
  AND status = 0;

-- 统计总可提取金额
SELECT SUM(available_amount) as total
FROM settlement
WHERE status IN (0);  -- 正常状态
```

---

### 7. Withdrawal 表（提现记录表）

**用途：** 记录所有提现申请和处理过程

**设计特点：**
- traceId 用于幂等性控制（防重复提交）
- status 记录提现流程（申请->处理->打款）
- 支持乐观锁（version 字段）

**关键字段：**
```sql
withdrawal_id           BIGINT         主键，自增
anchor_id               BIGINT         主播 ID
withdrawal_amount       DECIMAL(15,2)  提现金额
withdrawal_type         INT            0-银行卡、1-支付宝、2-微信
bank_card_encrypted     VARCHAR(255)   银行卡号（加密）
trace_id                VARCHAR(64)    幂等性控制（UNIQUE）
status                  INT            0-申请中、1-处理中、2-已打款、3-失败、4-已拒绝
reject_reason           VARCHAR(500)   拒绝原因
transfer_serial_number  VARCHAR(100)   转账流水号
applied_time            DATETIME       申请时间
processed_time          DATETIME       处理时间
version                 INT            版本号（乐观锁）
```

**状态转移：**
```
申请中(0) -> 处理中(1) -> 已打款(2)
      |                    
      +-> 拒绝(4)
      
处理中(1) -> 失败(3)
```

**查询示例：**
```sql
-- 查询待处理的提现（定时任务）
SELECT * FROM withdrawal 
WHERE status IN (0, 1)
ORDER BY applied_time ASC
LIMIT 100;

-- 查询主播的提现历史
SELECT * FROM withdrawal 
WHERE anchor_id = ?
ORDER BY applied_time DESC;

-- 统计主播的总提现金额
SELECT SUM(withdrawal_amount) as total
FROM withdrawal
WHERE anchor_id = ? AND status = 2;  -- 已打款
```

---

### 8. Commission_Rate 表（分成比例表）

**用途：** 记录主播分成比例的历史版本，支持版本管理

**设计特点：**
- 记录历史版本（支持版本追踪）
- status 管理比例的生效状态
- 支持复杂的时间段管理

**关键字段：**
```sql
commission_rate_id   BIGINT         主键，自增
anchor_id            BIGINT         主播 ID
commission_rate      DECIMAL(5,2)   分成比例（如 50 表示 50%）
effective_time       DATETIME       生效时间
expire_time          DATETIME       过期时间（NULL 表示未过期）
status               INT            0-未启用、1-启用、2-已过期
remark               VARCHAR(500)   操作备注（为什么调整）
```

**查询示例：**
```sql
-- 查询主播当前有效的分成比例
SELECT * FROM commission_rate 
WHERE anchor_id = ?
  AND status = 1
  AND effective_time <= NOW()
  AND (expire_time IS NULL OR expire_time > NOW())
ORDER BY effective_time DESC
LIMIT 1;

-- 查询待启用的比例调整
SELECT * FROM commission_rate 
WHERE status = 0
ORDER BY effective_time ASC;
```

---

## 🔗 表之间的关系

```
User (user_id)
├── Anchor (user_id → user.user_id)
│   ├── Live_Room (anchor_id → anchor.user_id)
│   │   ├── Recharge (live_room_id → live_room.live_room_id)
│   │   └── Live_Room_Tag (live_room_id → live_room.live_room_id)
│   ├── Settlement (anchor_id → anchor.user_id)
│   │   └── Settlement_Detail (settlement_id → settlement.settlement_id)
│   ├── Commission_Rate (anchor_id → anchor.user_id)
│   ├── Withdrawal (anchor_id → anchor.user_id)
│   └── Anchor_Tag (anchor_id → anchor.user_id)
│
└── Audience (user_id → user.user_id)
    ├── Recharge (audience_id → audience.user_id)
    ├── Live_Session_Audience (audience_id → audience.user_id)
    ├── Message (sender_id → audience.user_id)
    └── Audience_Tag (audience_id → audience.user_id)
```

---

## 💾 数据同步策略

### 同步方向

```
DB1 (观众服务) --同步打赏和用户数据--> DB2 (财务服务)
                                    ↓
                            生成统计和结算数据
```

### 同步表

**Sync_Progress 表：** 记录同步进度

```sql
progress_id           BIGINT         主键
sync_type             INT            0-打赏数据、1-用户数据
source_service        VARCHAR(50)    源服务（audience-service）
target_service        VARCHAR(50)    目标服务（finance-service）
last_sync_recharge_id BIGINT         最后同步的打赏 ID
total_synced_count    BIGINT         累计同步笔数
last_sync_time        DATETIME       最后同步时间
sync_status           INT            0-待同步、1-同步中、2-已同步、3-失败
```

---

## 🔐 数据一致性保证

### 1. 主键和外键约束
- 所有表都有主键
- 关键表使用外键约束（CASCADE 删除）
- 支持事务回滚

### 2. Unique 约束
- `user.username` - 用户名唯一
- `user.email` - 邮箱唯一
- `anchor.live_room_id` - 一一对应
- `recharge.trace_id` - 幂等性控制
- `withdrawal.trace_id` - 幂等性控制
- `settlement.anchor_id` - 一一对应

### 3. 索引优化
- 关键查询字段都有索引
- 范围查询使用复合索引
- 避免全表扫描

---

## 📈 性能注意事项

### 1. 大表分片建议

当数据量超过 1000 万时，建议对以下表分片：
- `recharge` - 按 `recharge_time` 月份分片
- `message` - 按 `create_time` 月份分片
- `withdrawal` - 按 `applied_time` 月份分片

### 2. 归档策略

建议定期归档已完成的数据：
- 已结算的打赏记录（recharge.status=2）
- 已打款的提现记录（withdrawal.status=2）
- 过期的分成比例（commission_rate.status=2）

### 3. 缓存策略

以下数据应该在 Redis 中缓存：
- `user` 表 - 用户基本信息
- `anchor` 表 - 主播排行榜数据
- `audience` 表 - 观众消费等级
- `settlement` 表 - 结算信息

---

## 📝 总结

| 表名 | 用途 | 关键特性 | 数据量 |
|-----|-----|---------|-------|
| user | 用户基础 | 继承关系、软删除 | 百万级 |
| anchor | 主播信息 | 一一对应、排行 | 十万级 |
| audience | 观众信息 | 消费等级、VIP体系 | 百万级 |
| live_room | 直播间 | 实时状态、统计 | 十万级 |
| recharge | 打赏记录 | 幂等性、核心业务 | 千万级 |
| settlement | 结算 | 可提取余额、历史 | 十万级 |
| withdrawal | 提现 | 幂等性、流程管理 | 百万级 |
| commission_rate | 分成比例 | 版本管理、历史 | 万级 |

---

最后更新：2026年1月6日
