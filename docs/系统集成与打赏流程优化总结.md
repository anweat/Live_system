# 系统集成与打赏流程优化总结

## 修改日期：2026-01-02

---

## 一、Nginx配置优化

### 文件：`services/nginx/docker/nginx.conf`

#### 修改内容：
为所有微服务路由添加了详细的API接口批注，方便运维和开发人员快速了解系统架构。

#### 接口统计：

**1. 主播服务 (anchor-service) - 37个接口**
- 主播管理接口：12个
- 直播间管理接口：10个
- 直播间实时数据接口：5个
- 分成比例管理接口：2个
- 提现管理接口：3个
- 打赏记录查询接口：5个

**2. 观众服务 (audience-service)**
- 观众管理接口：4个
- 打赏接口：8个（含TOP10统计）
- 数据同步接口：1个

**3. 财务服务 (finance-service)**
- 财务管理接口：2个
- 分成比例管理接口：5个
- 提现管理接口：6个
- 打赏同步接口：2个

**4. 数据分析服务 (data-analysis-service)**
- 数据分析接口：6个

**5. Redis缓存服务 (redis-service)**
- 缓存管理接口

#### 配置特点：
- ✅ HTTP/1.1 长连接支持（keepalive）
- ✅ 链路追踪ID透传（X-Trace-Id）
- ✅ 负载均衡（max_fails=2, fail_timeout=30s）
- ✅ 超时控制（connect 10s, send 30s, read 30s）
- ✅ Gzip压缩优化
- ✅ 请求体大小限制（20MB）

---

## 二、打赏流程优化

### 核心改动：观众打赏成功后实时通知直播间

#### 1. 新增文件

**AnchorServiceClient.java**
- 位置：`audience-service/src/main/java/com/liveroom/audience/feign/`
- 功能：Feign客户端，调用主播服务的实时数据接口
- 接口：`POST /anchor/api/v1/live-rooms/realtime/reward`

**AnchorServiceClientFallback.java**
- 位置：`audience-service/src/main/java/com/liveroom/audience/feign/`
- 功能：降级处理，主播服务不可用时不影响打赏记录保存
- 策略：记录日志，返回降级响应，但不抛出异常

#### 2. 修改文件

**RechargeService.java**
- 位置：`audience-service/src/main/java/com/liveroom/audience/service/`
- 修改点：
  1. 注入 `AnchorServiceClient`
  2. 在 `createRecharge()` 方法中，打赏记录保存成功后立即调用主播服务
  3. 采用异步容错机制，调用失败不影响打赏记录

---

## 三、完整的打赏流程

### 流程图：
```
观众端发起打赏请求
    ↓
观众服务 (audience-service)
    ↓
1. 参数验证 + 幂等性检查（traceId）
    ↓
2. 保存打赏记录到DB1 (recharge表)
    ↓
3. ✨ 实时通知主播服务 ✨
    ├─ 调用 anchor-service/api/v1/live-rooms/realtime/reward
    ├─ 更新直播间实时数据（Redis + live_room_realtime表）
    │   ├─ 递增累计收益
    │   ├─ 递增打赏次数
    │   └─ 触发批量更新机制（100次或5分钟）
    └─ 容错处理：失败不影响主流程
    ↓
4. 加入同步队列（待同步到财务服务）
    ↓
5. 更新观众消费统计
    ↓
返回成功响应（<200ms）
    ↓
定时任务（每5分钟）
    ├─ 批量同步到财务服务
    └─ 财务服务处理分成结算
```

### 关键特性：

**1. 实时性**
- 打赏成功后立即通知直播间
- 直播间实时数据通过Redis高速更新
- 观众端可以立即看到打赏效果

**2. 高可用性**
- 主播服务不可用时，打赏记录仍然保存
- 降级策略确保核心业务不受影响
- 异步容错机制保证系统稳定性

**3. 数据一致性**
- 打赏记录保存到DB1（观众服务数据库）
- 实时数据更新到Redis + live_room_realtime表
- 定时批量同步到财务服务确保最终一致性

**4. 性能优化**
- Redis缓存减少DB写压力
- 批量更新策略（100次或5分钟触发）
- 增量更新机制（只同步delta值）

---

## 四、数据流向

### 打赏数据的三个存储层：

**1. 观众服务数据库 (DB1)**
- 表：`recharge`
- 作用：打赏明细记录（完整历史）
- 更新：实时写入

**2. 主播服务实时数据 (Redis + DB1)**
- 表：`live_room_realtime`
- Redis键：
  - `live:room:earnings:{id}` - 累计收益（增量）
  - `live:room:recharge_count:{id}` - 打赏次数（增量）
- 作用：直播间实时统计数据
- 更新：高频写入Redis，定时批量同步到MySQL

**3. 财务服务数据库 (DB2)**
- 表：`settlement`, `settlement_detail`, `withdrawal`
- 作用：分成结算、提现管理
- 更新：定时任务批量同步

---

## 五、API调用关系

### 打赏相关的服务调用链：

```
前端/客户端
    ↓
Nginx (负载均衡)
    ↓
观众服务 (audience-service:8082)
    ├─ POST /audience/api/v1/recharge
    ├─ 保存打赏记录
    └─ Feign调用 ↓
主播服务 (anchor-service:8081)
    ├─ POST /anchor/api/v1/live-rooms/realtime/reward
    ├─ 更新Redis实时数据
    ├─ 触发批量更新机制
    └─ 定时同步到MySQL
```

### 数据同步任务：

```
观众服务定时任务 (每5分钟)
    ↓
批量获取同步队列中的打赏记录
    ↓
Feign调用 ↓
财务服务 (finance-service:8083)
    ├─ POST /finance/api/v1/recharge/batch-sync
    ├─ 计算分成比例
    ├─ 更新主播余额
    └─ 创建结算记录
```

---

## 六、错误处理与降级策略

### 主播服务不可用时：

**场景1：打赏时主播服务宕机**
- ✅ 打赏记录正常保存
- ⚠️ 直播间实时数据不更新（降级）
- 📝 记录降级日志
- 🔄 等待定时任务同步数据

**场景2：Feign调用超时**
- ✅ 打赏记录已保存
- ⚠️ 返回降级响应
- 📝 记录超时日志
- 🔄 后续通过数据对账补齐

**场景3：Redis不可用**
- ✅ 打赏记录保存
- ⚠️ 实时数据直接写入MySQL
- 📉 性能下降但功能正常
- 🔄 Redis恢复后自动切换

---

## 七、监控与运维

### 关键监控指标：

**1. 打赏成功率**
- 指标：`recharge_success_rate`
- 告警阈值：<95%

**2. 主播服务调用成功率**
- 指标：`anchor_service_call_success_rate`
- 告警阈值：<90%

**3. 打赏响应时间**
- 指标：`recharge_response_time_p99`
- 告警阈值：>500ms

**4. 同步队列积压**
- 指标：`sync_queue_size`
- 告警阈值：>1000

**5. Redis缓存命中率**
- 指标：`redis_hit_rate`
- 告警阈值：<85%

### 日志追踪：

每个打赏请求都有唯一的 `traceId`，方便全链路追踪：
```
[2026-01-02 10:30:45] [traceId: RC-20260102-103045-001] 
观众服务: 收到打赏请求 audienceId=123, amount=100.00
→ [2026-01-02 10:30:45] [traceId: RC-20260102-103045-001]
观众服务: 打赏记录已保存 rechargeId=456
→ [2026-01-02 10:30:45] [traceId: RC-20260102-103045-001]
观众服务: 调用主播服务 liveRoomId=789
→ [2026-01-02 10:30:45] [traceId: RC-20260102-103045-001]
主播服务: 收到打赏通知 liveRoomId=789, amount=100.00
→ [2026-01-02 10:30:45] [traceId: RC-20260102-103045-001]
主播服务: 实时数据已更新 Redis key=live:room:earnings:789
```

---

## 八、部署建议

### 1. Nginx配置
```bash
# 测试配置文件语法
nginx -t

# 重新加载配置（无需停机）
nginx -s reload

# 查看日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### 2. 服务启动顺序
```
1. Redis服务
2. 数据库服务 (MySQL)
3. 财务服务 (finance-service)
4. 主播服务 (anchor-service)
5. 观众服务 (audience-service)
6. 数据分析服务 (data-analysis-service)
7. Nginx (反向代理)
```

### 3. 健康检查
```bash
# 主播服务健康检查
curl http://localhost:8081/anchor/actuator/health

# 观众服务健康检查
curl http://localhost:8082/audience/actuator/health

# Nginx健康检查
curl http://localhost/health
```

---

## 九、性能测试建议

### 测试场景：

**1. 单笔打赏性能**
- 并发：1000 TPS
- 响应时间要求：P99 < 200ms
- 成功率要求：>99.9%

**2. 批量打赏压测**
- 并发：5000 TPS
- 响应时间要求：P99 < 500ms
- 成功率要求：>99%

**3. 主播服务降级测试**
- 场景：主播服务宕机
- 验证：打赏记录正常保存
- 验证：降级日志正确记录

**4. Redis故障模拟**
- 场景：Redis不可用
- 验证：数据直接写入MySQL
- 验证：性能下降但功能正常

---

## 十、版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|-----|------|---------|-------|
| v1.0 | 2026-01-02 | 初始版本 | Team |
| v1.1 | 2026-01-02 | 添加Nginx接口批注 | Team |
| v1.2 | 2026-01-02 | 优化打赏流程，添加实时通知 | Team |

---

**文档维护者**: Team  
**最后更新**: 2026-01-02
